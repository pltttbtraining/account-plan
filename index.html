<!doctype html>
<html lang="th">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Account Planning System - Prototype (One-file)</title>

  <!-- Bootstrap 5 CSS (CDN) -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">

  <!-- Chart.js -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>

  <!-- html2canvas + jsPDF for PDF export -->
  <script src="https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/jspdf@2.5.1/dist/jspdf.umd.min.js"></script>

  <style>
    body { padding: 1.25rem; background:#f7f9fc; }
    .card { margin-bottom:1rem; }
    .small-muted { font-size:0.85rem; color:#6c757d; }
    .watermark { position:fixed; right:10px; bottom:10px; opacity:0.12; font-weight:700; font-size:12px; }
    .required::after { content:" *"; color: #d00; }
    .tag { padding:0.15rem 0.45rem; border-radius:0.25rem; background:#e9ecef; margin-right:0.25rem; font-size:0.85rem; }
    .table-fixed { max-height:240px; overflow:auto; display:block; }
  </style>
</head>
<body>
  <div class="container">
    <h3>Account Planning System — Prototype</h3>
    <p class="small-muted">ตัวอย่างใช้งานบน browser (localStorage). ทดสอบ: สร้างลูกค้า → ดูรายงาน (passcode protected) → Export PDF</p>

    <!-- NAV -->
    <nav class="nav nav-pills mb-3">
      <button class="nav-link active" id="tab-form">Create / Edit Customer</button>
      <button class="nav-link" id="tab-list">Customer List & Search</button>
      <button class="nav-link" id="tab-report">Reports (Passcode)</button>
      <button class="nav-link" id="tab-admin">Admin / Audit</button>
    </nav>

    <!-- Main content -->
    <div id="content">

      <!-- FORM -->
      <div id="panel-form" class="card p-3">
        <h5>1) ฟอร์มกรอกข้อมูลลูกค้า</h5>
        <div class="small-muted mb-2">กรอกข้อมูลให้ครบ — ระบบจะสร้าง Customer ID อัตโนมัติ</div>

        <form id="customerForm" class="row g-3">
          <!-- created_by block -->
          <div class="col-12 col-md-6">
            <label class="form-label required">Employee name (ผู้กรอก)</label>
            <input type="text" id="employee_name" class="form-control" placeholder="ชื่อผู้กรอก (เช่น Somchai)">
          </div>
          <div class="col-6 col-md-3">
            <label class="form-label required">Employee ID</label>
            <input type="text" id="employee_id" class="form-control" placeholder="BR1234">
          </div>
          <div class="col-6 col-md-3">
            <label class="form-label required">Branch</label>
            <input type="text" id="branch" class="form-control" placeholder="Bangkok Central">
          </div>
          <div class="col-6 col-md-3">
            <label class="form-label">Zone</label>
            <input type="text" id="zone" class="form-control" placeholder="Zone A">
          </div>
          <div class="col-6 col-md-3">
            <label class="form-label required">RH (RH1-RH5)</label>
            <select id="rh" class="form-select">
              <option value="">เลือก RH</option>
              <option>RH1</option>
              <option>RH2</option>
              <option>RH3</option>
              <option>RH4</option>
              <option>RH5</option>
            </select>
          </div>

          <!-- Customer personal -->
          <div class="col-12"><hr></div>
          <div class="col-md-4">
            <label class="form-label required">ชื่อ</label>
            <input type="text" id="cust_first" class="form-control" placeholder="ชื่อ">
          </div>
          <div class="col-md-4">
            <label class="form-label required">นามสกุล</label>
            <input type="text" id="cust_last" class="form-control" placeholder="นามสกุล">
          </div>
          <div class="col-md-4">
            <label class="form-label">Phone</label>
            <input type="tel" id="cust_phone" class="form-control" placeholder="0812345678">
          </div>
          <div class="col-md-4">
            <label class="form-label">Email</label>
            <input type="email" id="cust_email" class="form-control" placeholder="example@domain.com">
          </div>
          <div class="col-12">
            <label class="form-label">ที่อยู่</label>
            <textarea id="cust_address" rows="2" class="form-control" placeholder="ที่อยู่"></textarea>
          </div>

          <!-- Family / Job -->
          <div class="col-12"><hr></div>
          <div class="col-md-4">
            <label class="form-label">DOB</label>
            <input type="date" id="cust_dob" class="form-control">
          </div>
          <div class="col-md-4">
            <label class="form-label">สถานภาพสมรส</label>
            <input type="text" id="cust_marital" class="form-control" placeholder="โสด / สมรส">
          </div>
          <div class="col-md-4">
            <label class="form-label">ผู้ร่วมอาศัย</label>
            <input type="text" id="cust_household" class="form-control" placeholder="เช่น เกิดขึ้น: แม่, ภรรยา, ลูก 2 คน (อายุ)">
          </div>
          <div class="col-md-6">
            <label class="form-label">อาชีพ / ธุรกิจ</label>
            <input type="text" id="cust_occupation" class="form-control" placeholder="วิศวกร / เจ้าของกิจการ">
          </div>
          <div class="col-md-3">
            <label class="form-label">รายได้จริง / เดือน (บาท)</label>
            <input type="number" id="cust_income" class="form-control" placeholder="30000">
          </div>

          <!-- Products -->
          <div class="col-12"><hr></div>
          <div class="col-12">
            <label class="form-label">ผลิตภัณฑ์ที่มีอยู่ (เพิ่มได้หลายรายการ)</label>
            <div class="d-flex gap-2 mb-2">
              <input type="text" id="prod_name" class="form-control" placeholder="ชื่อผลิตภัณฑ์ (เช่น ABC Life 20Y)">
              <input type="number" id="prod_sum" class="form-control" placeholder="Sum Assured / มูลค่า">
              <input type="number" id="prod_premium" class="form-control" placeholder="เบี้ย/ปี">
              <button type="button" id="btnAddProd" class="btn btn-outline-primary">เพิ่ม</button>
            </div>
            <div id="prodList" class="mb-2"></div>
          </div>

          <!-- Opportunity -->
          <div class="col-12"><hr></div>
          <div class="col-md-4">
            <label class="form-label">Opportunity Type</label>
            <select id="opp_type" class="form-select">
              <option value="">เลือก</option>
              <option>Protection</option>
              <option>Wealth</option>
              <option>Health</option>
              <option>Savings</option>
            </select>
          </div>
          <div class="col-md-4">
            <label class="form-label">Estimated Value (THB)</label>
            <input type="number" id="opp_value" class="form-control" placeholder="ประมาณมูลค่า">
          </div>
          <div class="col-4">
            <label class="form-label">Status</label>
            <input type="text" id="opp_status" class="form-control" placeholder="Open / In-progress / Closed">
          </div>
          <div class="col-12">
            <label class="form-label">ความคิดเห็นของพนักงาน (1-2 ประโยค)</label>
            <textarea id="opp_comment" rows="2" class="form-control"></textarea>
          </div>

          <!-- Attachments -->
          <div class="col-12"><hr></div>
          <div class="col-md-6">
            <label class="form-label">Attach file (PDF/JPG/PNG)</label>
            <input type="file" id="file_attach" class="form-control">
            <div id="attachList" class="mt-2"></div>
          </div>

          <!-- Consent (PDPA demo) -->
          <div class="col-12">
            <div class="form-check">
              <input class="form-check-input" type="checkbox" id="consent" checked>
              <label class="form-check-label small-muted" for="consent">
                ลูกค้ายินยอมให้เก็บข้อมูลสำหรับการนำเสนอผลิตภัณฑ์ (Consent recorded)
              </label>
            </div>
          </div>

          <!-- Buttons -->
          <div class="col-12 d-flex gap-2">
            <button type="button" id="btnSave" class="btn btn-primary">บันทึกข้อมูล (Create)</button>
            <button type="button" id="btnClear" class="btn btn-secondary">ล้างฟอร์ม</button>
            <div class="ms-auto small-muted align-self-center" id="formStatus"></div>
          </div>
        </form>
      </div>

      <!-- LIST / SEARCH -->
      <div id="panel-list" class="card p-3" style="display:none;">
        <h5>2) รายการลูกค้า / ค้นหา</h5>
        <div class="row g-2 mb-2">
          <div class="col-md-3">
            <input type="text" id="search_customer" class="form-control" placeholder="Search Customer ID">
          </div>
          <div class="col-md-3">
            <input type="text" id="search_by_creator" class="form-control" placeholder="Search by Employee ID">
          </div>
          <div class="col-md-3">
            <select id="filter_rh" class="form-select">
              <option value="">Filter RH</option>
              <option>RH1</option>
              <option>RH2</option>
              <option>RH3</option>
              <option>RH4</option>
              <option>RH5</option>
            </select>
          </div>
          <div class="col-md-3 d-flex gap-2">
            <button class="btn btn-outline-primary" id="btnSearch">ค้นหา</button>
            <button class="btn btn-outline-secondary" id="btnRefresh">รีเฟรชทั้งหมด</button>
            <button class="btn btn-outline-success" id="btnBulkExport">Export Selected → PDF</button>
          </div>
        </div>

        <div class="table-responsive table-fixed">
          <table class="table table-striped" id="customerTable">
            <thead class="table-light">
              <tr>
                <th><input type="checkbox" id="selectAll"></th>
                <th>Customer ID</th>
                <th>Name</th>
                <th>Branch</th>
                <th>RH</th>
                <th>Created By</th>
                <th>Created At</th>
                <th>Actions</th>
              </tr>
            </thead>
            <tbody id="customerTbody"></tbody>
          </table>
        </div>
      </div>

      <!-- REPORTS (Passcode protected) -->
      <div id="panel-report" class="card p-3" style="display:none;">
        <h5>3) รายงาน / Dashboard (Passcode protected)</h5>
        <div id="reportLocked" class="mb-3">
          <p class="small-muted">กรุณาใส่ Passcode เพื่อเข้าใช้งานเมนูรายงาน</p>
          <div class="d-flex gap-2">
            <input type="password" id="reportPass" class="form-control" placeholder="Passcode">
            <button id="btnUnlock" class="btn btn-primary">Unlock</button>
            <div class="ms-auto small-muted align-self-center">(default demo passcode: <strong>2568</strong>)</div>
          </div>
          <div class="form-text small text-danger mt-1">คำเตือน: passcode คงที่ไม่ปลอดภัยสำหรับ production — เปลี่ยนเป็น SSO/temporary token</div>
        </div>

        <div id="reportPanel" style="display:none;">
          <div class="row mb-3">
            <div class="col-md-3">
              <div class="card p-2 text-center">
                <div class="small-muted">Total Cases MTD</div>
                <div id="kpi_total" class="h4">0</div>
              </div>
            </div>
            <div class="col-md-3">
              <div class="card p-2 text-center">
                <div class="small-muted">New Opportunities MTD</div>
                <div id="kpi_opp_count" class="h4">0</div>
              </div>
            </div>
            <div class="col-md-3">
              <div class="card p-2 text-center">
                <div class="small-muted">Est. Opportunity Value (MTD)</div>
                <div id="kpi_opp_value" class="h5">0</div>
              </div>
            </div>
            <div class="col-md-3">
              <div class="card p-2 text-center">
                <div class="small-muted">Top Branch (cases)</div>
                <div id="kpi_top_branch" class="h6">-</div>
              </div>
            </div>
          </div>

          <div class="row mb-3">
            <div class="col-md-6">
              <canvas id="chartRh" height="200"></canvas>
            </div>
            <div class="col-md-6">
              <canvas id="chartBranch" height="200"></canvas>
            </div>
          </div>

          <div class="mb-3">
            <h6>Recent activity</h6>
            <div id="recentActivity" class="small-muted"></div>
          </div>

          <div class="d-flex gap-2">
            <button id="btnExportAll" class="btn btn-outline-primary">Export All → Multi-page PDF</button>
            <button id="btnExportCSV" class="btn btn-outline-secondary">Export CSV</button>
          </div>
        </div>
      </div>

      <!-- ADMIN / AUDIT -->
      <div id="panel-admin" class="card p-3" style="display:none;">
        <h5>4) Admin / Audit</h5>
        <div class="small-muted mb-2">Audit log (view only) — บันทึกการสร้าง แก้ไข และ export</div>
        <div id="auditList" class="small-muted"></div>
        <div class="mt-3">
          <button id="btnResetAll" class="btn btn-danger">[Danger] Reset all data (localStorage)</button>
          <div class="form-text small text-danger">ใช้ใน demo เท่านั้น — จะลบข้อมูลทุกอย่าง</div>
        </div>
      </div>

    </div> <!-- content -->

    <div class="watermark">Prototype — For internal demo</div>
  </div>

  <!-- SCRIPT -->
  <script>
    /**************************************************************************
     * Account Planning System — Single HTML prototype
     * - Storage: localStorage (key: 'aps_customers', 'aps_audit', 'aps_counters')
     * - Passcode for report: default '2568' (demo only) -> change in production
     * - PDF export uses html2canvas + jsPDF
     *
     * Usage:
     * - Create / edit customers
     * - Search by customer code or created_by
     * - View Reports (MTD) after unlocking with passcode
     **************************************************************************/

    // ---------- Utilities ----------
    const STORAGE_KEY = 'aps_customers';
    const AUDIT_KEY = 'aps_audit';
    const COUNTER_KEY = 'aps_counters';
    const REPORT_PASSCODE = '2568'; // demo only! replace with secure auth

    function nowISO() {
      return new Date().toISOString();
    }

    function formatDateISOToLocalShort(iso) {
      if (!iso) return '';
      const d = new Date(iso);
      return d.toLocaleString('th-TH', { year:'numeric', month:'short', day:'numeric', hour:'2-digit', minute:'2-digit' });
    }

    function loadData() {
      try {
        const raw = localStorage.getItem(STORAGE_KEY);
        return raw ? JSON.parse(raw) : [];
      } catch(e) { return []; }
    }
    function saveData(arr) { localStorage.setItem(STORAGE_KEY, JSON.stringify(arr)); }

    function loadAudit() {
      try { return JSON.parse(localStorage.getItem(AUDIT_KEY) || '[]'); } catch(e) { return []; }
    }
    function saveAudit(a) { localStorage.setItem(AUDIT_KEY, JSON.stringify(a)); }

    function appendAudit(action, entityId, performedBy, data=null) {
      const a = loadAudit();
      a.unshift({ action, entity: entityId, performed_by: performedBy, time: nowISO(), data });
      saveAudit(a);
    }

    // Manage simple sequential counter per day for Customer code
    function genCustomerCode() {
      const counters = JSON.parse(localStorage.getItem(COUNTER_KEY) || '{}');
      const dateKey = new Date().toISOString().slice(0,10).replace(/-/g,''); // YYYYMMDD
      counters[dateKey] = (counters[dateKey] || 0) + 1;
      localStorage.setItem(COUNTER_KEY, JSON.stringify(counters));
      const seq = String(counters[dateKey]).padStart(4,'0');
      return `CUST${dateKey}-${seq}`;
    }

    // ---------- DOM helpers ----------
    const $ = (id) => document.getElementById(id);

    // ---------- Products UI ----------
    let tmpProducts = [];
    function renderProdList() {
      const container = $('prodList');
      container.innerHTML = tmpProducts.map((p,idx) => `
        <div class="d-flex align-items-center mb-1" data-idx="${idx}">
          <div class="me-auto">
            <strong>${p.product_name || ''}</strong>
            <div class="small-muted">Sum: ${p.sum_assured || 0} | Premium: ${p.premium || 0}</div>
          </div>
          <button class="btn btn-sm btn-outline-danger" onclick="removeProd(${idx})">ลบ</button>
        </div>
      `).join('') || '<div class="small-muted">ยังไม่มีผลิตภัณฑ์</div>';
    }
    function removeProd(i) { tmpProducts.splice(i,1); renderProdList(); }

    // ---------- Attachment handling ----------
    let tmpAttachments = []; // {name, type, dataUrl}
    function renderAttachList() {
      const container = $('attachList');
      container.innerHTML = tmpAttachments.map((f,idx) => `
        <div class="d-flex align-items-center mb-1">
          <div class="me-auto small-muted">${f.name} (${f.type})</div>
          <button class="btn btn-sm btn-outline-danger" onclick="removeAttach(${idx})">ลบ</button>
        </div>
      `).join('') || '<div class="small-muted">ยังไม่มีไฟล์แนบ</div>';
    }
    function removeAttach(i) { tmpAttachments.splice(i,1); renderAttachList(); }

    // ---------- Form actions ----------
    $('btnAddProd').addEventListener('click', () => {
      const name = $('prod_name').value.trim();
      const sum = Number($('prod_sum').value || 0);
      const prem = Number($('prod_premium').value || 0);
      if (!name) return alert('กรุณาใส่ชื่อผลิตภัณฑ์');
      tmpProducts.push({ product_name: name, sum_assured: sum, premium: prem });
      $('prod_name').value=''; $('prod_sum').value=''; $('prod_premium').value='';
      renderProdList();
    });

    $('file_attach').addEventListener('change', async (ev) => {
      const f = ev.target.files[0];
      if (!f) return;
      // limit file size to 2MB for demo
      if (f.size > 2 * 1024 * 1024) { alert('ไฟล์ใหญ่เกิน 2MB (demo limit)'); return; }
      const reader = new FileReader();
      reader.onload = () => {
        tmpAttachments.push({ name: f.name, type: f.type, dataUrl: reader.result });
        renderAttachList();
      };
      reader.readAsDataURL(f);
      ev.target.value = '';
    });

    function clearForm() {
      document.getElementById('customerForm').reset();
      tmpProducts = []; tmpAttachments = [];
      renderProdList(); renderAttachList();
      $('formStatus').textContent = '';
    }
    $('btnClear').addEventListener('click', clearForm);

    // Save / Create function
    $('btnSave').addEventListener('click', () => {
      // validation minimal
      const required = [
        ['employee_name','กรอกชื่อผู้กรอก'],
        ['employee_id','กรอก Employee ID'],
        ['branch','กรอก Branch'],
        ['cust_first','กรอกชื่อ'],
        ['cust_last','กรอกนามสกุล'],
        ['rh','เลือก RH']
      ];
      for (let [id,msg] of required) {
        const el = $(id);
        if (!el) continue;
        if (!el.value || el.value.trim()==='') { alert(msg); el.focus(); return; }
      }

      const createdBy = $('employee_id').value.trim();
      const empName = $('employee_name').value.trim();
      const branch = $('branch').value.trim();
      const zone = $('zone').value.trim();
      const rh = $('rh').value.trim();

      const customer = {
        customer_id: genCustomerCode(),
        first_name: $('cust_first').value.trim(),
        last_name: $('cust_last').value.trim(),
        phone: $('cust_phone').value.trim(),
        email: $('cust_email').value.trim(),
        address: $('cust_address').value.trim(),
        dob: $('cust_dob').value || null,
        marital_status: $('cust_marital').value.trim(),
        household: $('cust_household').value.trim(),
        occupation: $('cust_occupation').value.trim(),
        monthly_income: Number($('cust_income').value || 0),
        branch, zone, rh,
        products: tmpProducts.slice(),
        opportunities: [{
          type: $('opp_type').value || null,
          estimated_value: Number($('opp_value').value || 0),
          status: $('opp_status').value || null,
          comment: $('opp_comment').value.trim(),
          created_at: nowISO(),
          created_by: createdBy
        }],
        attachments: tmpAttachments.slice(),
        created_by: createdBy,
        created_by_name: empName,
        consent: !!$('consent').checked,
        created_at: nowISO(),
        updated_at: nowISO()
      };

      const all = loadData();
      all.unshift(customer);
      saveData(all);
      appendAudit('create', customer.customer_id, createdBy, { first_name: customer.first_name, branch });
      clearForm();
      $('formStatus').textContent = `บันทึกเรียบร้อย: ${customer.customer_id}`;
      refreshList();
      // if report unlocked, also refresh report
      if (reportUnlocked) renderReport();
    });

    // ---------- List / Search ----------
    function renderTableRows(list) {
      const tbody = $('customerTbody');
      tbody.innerHTML = list.map(c => `
        <tr>
          <td><input type="checkbox" class="rowSelect" data-id="${c.customer_id}"></td>
          <td>${c.customer_id}</td>
          <td>${c.first_name} ${c.last_name}</td>
          <td>${c.branch || '-'}</td>
          <td>${c.rh || '-'}</td>
          <td>${c.created_by || '-'}</td>
          <td>${formatDateISOToLocalShort(c.created_at)}</td>
          <td>
            <button class="btn btn-sm btn-outline-primary" onclick="viewDetail('${c.customer_id}')">View</button>
            <button class="btn btn-sm btn-outline-secondary" onclick="exportSinglePDF('${c.customer_id}')">PDF</button>
            <button class="btn btn-sm btn-outline-danger" onclick="deleteRecord('${c.customer_id}')">Del</button>
          </td>
        </tr>
      `).join('');
    }

    function refreshList() {
      const all = loadData();
      renderTableRows(all);
    }
    $('btnRefresh').addEventListener('click', refreshList);

    $('btnSearch').addEventListener('click', () => {
      const q = $('search_customer').value.trim().toLowerCase();
      const by = $('search_by_creator').value.trim().toLowerCase();
      const rh = $('filter_rh').value.trim();
      let all = loadData();
      if (q) all = all.filter(c => c.customer_id.toLowerCase().includes(q) || (c.first_name + ' ' + c.last_name).toLowerCase().includes(q));
      if (by) all = all.filter(c => (c.created_by || '').toLowerCase().includes(by) || (c.created_by_name || '').toLowerCase().includes(by));
      if (rh) all = all.filter(c => (c.rh || '') === rh);
      renderTableRows(all);
    });

    // bulk export selected
    $('btnBulkExport').addEventListener('click', async () => {
      const checks = Array.from(document.querySelectorAll('.rowSelect:checked'));
      if (!checks.length) return alert('เลือกอย่างน้อย 1 รายการเพื่อ export');
      const ids = checks.map(ch => ch.dataset.id);
      const all = loadData();
      const items = all.filter(c => ids.includes(c.customer_id));
      // Multi-page PDF: create each as a page
      await exportMultiplePDF(items);
      appendAudit('export_bulk_pdf', `bulk:${ids.join(',')}`, 'local-user', { count: items.length });
    });

    // select all
    $('selectAll').addEventListener('change', (e) => {
      document.querySelectorAll('.rowSelect').forEach(cb => cb.checked = e.target.checked);
    });

    // view detail -> show modal-like (simple)
    window.viewDetail = function(customerId) {
      const all = loadData();
      const c = all.find(x => x.customer_id === customerId);
      if (!c) return alert('ไม่พบข้อมูล');
      // show detail in a prompt-like modal (simple)
      const html = `
        <div>
          <h5>${c.first_name} ${c.last_name} (${c.customer_id})</h5>
          <div><strong>Branch:</strong> ${c.branch} | <strong>RH:</strong> ${c.rh}</div>
          <div><strong>Phone:</strong> ${c.phone || '-'} | <strong>Email:</strong> ${c.email || '-'}</div>
          <hr>
          <div><strong>Occupation:</strong> ${c.occupation || '-'} | <strong>Income:</strong> ${c.monthly_income || 0}</div>
          <hr>
          <div><strong>Products:</strong>
            <ul>${(c.products||[]).map(p=>`<li>${p.product_name} | Sum: ${p.sum_assured || 0} | Premium: ${p.premium || 0}</li>`).join('') || '<li>-</li>'}</ul>
          </div>
          <div><strong>Opportunities:</strong>
            <ul>${(c.opportunities||[]).map(o=>`<li>${o.type || '-'} | ${o.estimated_value || 0} | ${o.status || '-'}<br><small class="small-muted">${o.comment||''} — added:${formatDateISOToLocalShort(o.created_at)}</small></li>`).join('')}</ul>
          </div>
          <div><strong>Attachments:</strong>
            <ul>${(c.attachments||[]).map(a=>`<li>${a.name} (${a.type}) <a href="${a.dataUrl}" target="_blank">View</a></li>`).join('') || '<li>-</li>'}</ul>
          </div>
          <div class="small-muted">Created by: ${c.created_by_name || c.created_by} | ${formatDateISOToLocalShort(c.created_at)}</div>
        </div>
      `;
      const w = window.open('', '_blank', 'width=800,height=600');
      w.document.write(html);
      w.document.close();
    };

    // delete record (demo)
    window.deleteRecord = function(customerId) {
      if (!confirm('ลบรายการนี้จริงหรือไม่?')) return;
      let all = loadData();
      all = all.filter(x => x.customer_id !== customerId);
      saveData(all);
      appendAudit('delete', customerId, 'local-user', null);
      refreshList();
      if (reportUnlocked) renderReport();
    };

    // ---------- PDF Export functions ----------
    async function exportSinglePDF(customerId) {
      const all = loadData();
      const c = all.find(x => x.customer_id === customerId);
      if (!c) return alert('ไม่พบข้อมูล');
      await exportMultiplePDF([c]);
      appendAudit('export_pdf', customerId, 'local-user', null);
    }

    // render HTML fragment and convert to pdf pages
    async function exportMultiplePDF(items) {
      // For each item, render a HTML container then capture with html2canvas -> add as page
      const { jsPDF } = window.jspdf;
      const doc = new jsPDF({ unit:'px', format:'a4' });
      for (let i=0;i<items.length;i++) {
        const c = items[i];
        const wrapper = document.createElement('div');
        wrapper.style.width = '794px'; // ~A4 595x842 px at 72dpi, but use 794x1123 for 96dpi style — OK for demo
        wrapper.style.padding = '20px';
        wrapper.style.background = '#fff';
        wrapper.innerHTML = `
          <div style="font-family: Arial, Helvetica, sans-serif; color:#111;">
            <h2 style="margin:0;">Customer Summary — ${c.customer_id}</h2>
            <div style="color:#666;">Generated: ${formatDateISOToLocalShort(nowISO())}</div>
            <hr>
            <h4>Basic</h4>
            <div><strong>Name:</strong> ${c.first_name} ${c.last_name}</div>
            <div><strong>Phone / Email:</strong> ${c.phone || '-'} / ${c.email || '-'}</div>
            <div><strong>Branch / Zone / RH:</strong> ${c.branch || '-'} / ${c.zone || '-'} / ${c.rh || '-'}</div>
            <div><strong>Occupation / Income:</strong> ${c.occupation || '-'} / ${c.monthly_income || 0}</div>
            <hr>
            <h4>Products</h4>
            <table style="width:100%; border-collapse:collapse;">
              <thead><tr><th style="text-align:left">Name</th><th style="text-align:right">Sum</th><th style="text-align:right">Premium</th></tr></thead>
              <tbody>
                ${ (c.products||[]).map(p=>`<tr><td>${p.product_name}</td><td style="text-align:right">${p.sum_assured||0}</td><td style="text-align:right">${p.premium||0}</td></tr>`).join('') || '<tr><td>-</td><td>-</td><td>-</td></tr>' }
              </tbody>
            </table>
            <hr>
            <h4>Opportunities</h4>
            ${ (c.opportunities||[]).map(o=>`<div><strong>${o.type||'-'}</strong> | ${o.estimated_value||0} THB | ${o.status||'-'}<div style="color:#666">${o.comment||''}</div></div>`).join('') }
            <hr>
            <div style="font-size:11px;color:#999;">Confidential — For internal use only. Exported by demo system.</div>
          </div>
        `;
        document.body.appendChild(wrapper);
        // use html2canvas
        // scale to improve quality
        const canvas = await html2canvas(wrapper, { scale: 2, useCORS:true, backgroundColor: '#ffffff' });
        document.body.removeChild(wrapper);
        const imgData = canvas.toDataURL('image/png');
        const imgProps = doc.getImageProperties(imgData);
        const pdfWidth = doc.internal.pageSize.getWidth();
        const pdfHeight = (imgProps.height * pdfWidth) / imgProps.width;
        doc.addImage(imgData, 'PNG', 0, 0, pdfWidth, pdfHeight);
        if (i < items.length - 1) doc.addPage();
      }
      // download
      doc.save(`APS_export_${new Date().toISOString().slice(0,19).replace(/[:T]/g,'_')}.pdf`);
    }

    // ---------- Reports (MTD) ----------
    let reportUnlocked = false;
    $('btnUnlock').addEventListener('click', () => {
      const v = $('reportPass').value.trim();
      if (v === REPORT_PASSCODE) {
        reportUnlocked = true;
        $('reportLocked').style.display = 'none';
        $('reportPanel').style.display = 'block';
        appendAudit('report_unlock', 'report_panel', 'local-user', null);
        renderReport();
      } else {
        alert('Passcode ไม่ถูกต้อง');
      }
    });

    // helper: is date in current month-to-date
    function isMTD(isoDate) {
      if (!isoDate) return false;
      const d = new Date(isoDate);
      const now = new Date();
      return d.getFullYear() === now.getFullYear() && d.getMonth() === now.getMonth() && d.getDate() <= now.getDate();
    }

    // build report data and render charts
    async function renderReport() {
      const all = loadData();
      // filter MTD
      const listMTD = all.filter(c => isMTD(c.created_at));
      $('kpi_total').textContent = listMTD.length;
      const opps = listMTD.flatMap(c => (c.opportunities||[]).map(o => ({...o, customer_id: c.customer_id})));
      $('kpi_opp_count').textContent = opps.length;
      const totalOppVal = opps.reduce((s,o)=> s + (Number(o.estimated_value)||0), 0);
      $('kpi_opp_value').textContent = totalOppVal.toLocaleString();
      // top branch
      const branchCounts = {};
      listMTD.forEach(c => { branchCounts[c.branch] = (branchCounts[c.branch]||0)+1; });
      const topBranch = Object.entries(branchCounts).sort((a,b)=>b[1]-a[1])[0];
      $('kpi_top_branch').textContent = topBranch ? `${topBranch[0]} (${topBranch[1]})` : '-';

      // RH counts
      const rhLabels = ['RH1','RH2','RH3','RH4','RH5'];
      const rhData = rhLabels.map(r => listMTD.filter(c => c.rh === r).length);

      // Branch chart top 10
      const branchEntries = Object.entries(branchCounts).sort((a,b)=>b[1]-a[1]).slice(0,10);
      const branchLabels = branchEntries.map(e=>e[0]||'-');
      const branchVals = branchEntries.map(e=>e[1]);

      // render charts
      const ctxRh = $('chartRh').getContext('2d');
      if (window._chartRh) window._chartRh.destroy();
      window._chartRh = new Chart(ctxRh, {
        type: 'bar',
        data: { labels: rhLabels, datasets: [{ label:'Cases MTD', data: rhData }] },
        options: { responsive:true, maintainAspectRatio:false }
      });

      const ctxBranch = $('chartBranch').getContext('2d');
      if (window._chartBranch) window._chartBranch.destroy();
      window._chartBranch = new Chart(ctxBranch, {
        type: 'bar',
        data: { labels: branchLabels, datasets: [{ label:'Top Branches', data: branchVals }] },
        options: { responsive:true, maintainAspectRatio:false }
      });

      // recent activity (last 10 audit)
      const audits = loadAudit().slice(0,10);
      $('recentActivity').innerHTML = audits.map(a => `<div>[${formatDateISOToLocalShort(a.time)}] <strong>${a.action}</strong> — ${a.entity} by ${a.performed_by}</div>`).join('');
    }

    // export CSV
    $('btnExportCSV').addEventListener('click', () => {
      const all = loadData();
      const rows = all.map(c => ({
        customer_id: c.customer_id,
        name: `${c.first_name} ${c.last_name}`,
        branch: c.branch,
        rh: c.rh,
        created_by: c.created_by,
        created_at: c.created_at
      }));
      const csv = [Object.keys(rows[0]||{}).join(',')].concat(rows.map(r => Object.values(r).map(v=>`"${String(v||'').replace(/"/g,'""')}"`).join(','))).join('\n');
      const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a'); a.href = url; a.download = `aps_export_${new Date().toISOString().slice(0,10)}.csv`; a.click(); URL.revokeObjectURL(url);
      appendAudit('export_csv', 'all', 'local-user', { count: rows.length });
    });

    // export all (multi-page PDF)
    $('btnExportAll').addEventListener('click', async () => {
      const all = loadData();
      if (!all.length) return alert('ไม่มีข้อมูลสำหรับ export');
      await exportMultiplePDF(all);
      appendAudit('export_all_pdf', 'all', 'local-user', { count: all.length });
    });

    // ---------- Admin / Audit ----------
    function renderAuditList() {
      const a = loadAudit();
      $('auditList').innerHTML = a.map(x => `<div>${formatDateISOToLocalShort(x.time)} — <strong>${x.action}</strong> ${x.entity} by ${x.performed_by}</div>`).join('') || '<div class="small-muted">ยังไม่มี log</div>';
    }

    $('btnResetAll').addEventListener('click', () => {
      if (!confirm('จะลบข้อมูลทั้งหมดใน localStorage ใช่หรือไม่?')) return;
      localStorage.removeItem(STORAGE_KEY);
      localStorage.removeItem(AUDIT_KEY);
      localStorage.removeItem(COUNTER_KEY);
      refreshList(); renderAuditList(); if (reportUnlocked) renderReport();
    });

    // ---------- Navigation tabs ----------
    $('tab-form').addEventListener('click', () => { showPanel('form'); });
    $('tab-list').addEventListener('click', () => { showPanel('list'); });
    $('tab-report').addEventListener('click', () => { showPanel('report'); });
    $('tab-admin').addEventListener('click', () => { showPanel('admin'); });

    function showPanel(name) {
      document.querySelectorAll('.nav-link').forEach(n => n.classList.remove('active'));
      if (name==='form') $('tab-form').classList.add('active');
      if (name==='list') $('tab-list').classList.add('active');
      if (name==='report') $('tab-report').classList.add('active');
      if (name==='admin') $('tab-admin').classList.add('active');

      $('panel-form').style.display = (name==='form') ? 'block' : 'none';
      $('panel-list').style.display = (name==='list') ? 'block' : 'none';
      $('panel-report').style.display = (name==='report') ? 'block' : 'none';
      $('panel-admin').style.display = (name==='admin') ? 'block' : 'none';
    }

    // ---------- Init ----------
    function initDemoData() {
      // If no data exists, seed small demo
      if (loadData().length === 0) {
        const demo = [
          { customer_id: genCustomerCode(), first_name:'สมชาย', last_name:'ใจดี', phone:'0811111111', email:'s@example.com', branch:'Bangkok Central', zone:'Zone A', rh:'RH1', products:[], opportunities:[{type:'Protection', estimated_value:50000, status:'Open', comment:'Need health cover', created_at:nowISO(), created_by:'BR1001'}], created_by:'BR1001', created_by_name:'Somchai', created_at: nowISO(), updated_at: nowISO(), attachments:[], occupation:'พนักงานบริษัท', monthly_income:40000, consent:true },
          { customer_id: genCustomerCode(), first_name:'มาลี', last_name:'สมหวัง', phone:'0822222222', email:'m@example.com', branch:'North Branch', zone:'Zone B', rh:'RH3', products:[], opportunities:[{type:'Wealth', estimated_value:200000, status:'Open', comment:'Has savings to invest', created_at:nowISO(), created_by:'BR2002'}], created_by:'BR2002', created_by_name:'Malee', created_at: nowISO(), updated_at: nowISO(), attachments:[], occupation:'เจ้าของกิจการ', monthly_income:90000, consent:true }
        ];
        saveData(demo);
      }
    }

    // initial render
    initDemoData();
    refreshList();
    renderAuditList();
    // default show form
    showPanel('form');

    // render product and attachment lists initially
    renderProdList();
    renderAttachList();

    // ensure when table rows are updated, selectAll works
    document.addEventListener('click', (e) => {
      if (e.target && e.target.matches('.rowSelect')) {
        const all = document.querySelectorAll('.rowSelect');
        const checked = Array.from(all).every(cb => cb.checked);
        $('selectAll').checked = checked;
      }
    });

    // Expose some functions to window for buttons created in markup
    window.exportSinglePDF = exportSinglePDF;
    window.deleteRecord = deleteRecord;
    window.viewDetail = viewDetail;
    window.removeProd = removeProd;
    window.removeAttach = removeAttach;
  </script>
</body>
</html>
