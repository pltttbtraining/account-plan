<!DOCTYPE html>
<html lang="th">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Account Planning System - Enhanced Version</title>

  <!-- Bootstrap 5 CSS -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">

  <!-- Chart.js -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>

  <!-- html2canvas + jsPDF -->
  <script src="https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/jspdf@2.5.1/dist/jspdf.umd.min.js"></script>

  <!-- Font Awesome -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

  <style>
    :root {
      --primary-color: #007AFF;
      --primary-dark: #0056CC;
      --secondary-color: #5856D6;
      --success-color: #34C759;
      --warning-color: #FF9500;
      --error-color: #FF3B30;
      --bg-gradient: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      --glass-bg: rgba(255, 255, 255, 0.25);
      --glass-border: rgba(255, 255, 255, 0.18);
      --glass-shadow: 0 8px 32px 0 rgba(31, 38, 135, 0.37);
      --text-primary: #1D1D1F;
      --text-secondary: #86868B;
      --text-white: #FFFFFF;
      --border-radius: 12px;
      --border-radius-lg: 20px;
      --spacing-xs: 0.5rem;
      --spacing-sm: 1rem;
      --spacing-md: 1.5rem;
      --spacing-lg: 2rem;
      --spacing-xl: 3rem;
    }

    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Roboto', 'Oxygen', 'Ubuntu', 'Cantarell', sans-serif;
      background: var(--bg-gradient);
      min-height: 100vh;
      color: var(--text-primary);
      line-height: 1.6;
      padding: 1.25rem;
    }

    .glass-container {
      background: var(--glass-bg);
      backdrop-filter: blur(10px);
      border-radius: var(--border-radius-lg);
      border: 1px solid var(--glass-border);
      box-shadow: var(--glass-shadow);
    }

    .glass-card {
      background: rgba(255, 255, 255, 0.9);
      backdrop-filter: blur(10px);
      border-radius: var(--border-radius);
      border: 1px solid rgba(255, 255, 255, 0.3);
      box-shadow: 0 4px 16px rgba(0, 0, 0, 0.1);
    }

    .app-container {
      min-height: calc(100vh - 2.5rem);
      display: flex;
      flex-direction: column;
    }

    .main-nav {
      background: rgba(255, 255, 255, 0.95);
      backdrop-filter: blur(10px);
      padding: var(--spacing-md) var(--spacing-lg);
      display: flex;
      justify-content: space-between;
      align-items: center;
      box-shadow: 0 2px 20px rgba(0, 0, 0, 0.1);
      border-radius: var(--border-radius);
      margin-bottom: var(--spacing-lg);
      position: sticky;
      top: 1.25rem;
      z-index: 1000;
    }

    .nav-brand {
      font-size: 1.5rem;
      font-weight: 700;
      color: var(--primary-color);
      display: flex;
      align-items: center;
      gap: var(--spacing-sm);
    }

    .nav-menu {
      display: flex;
      gap: var(--spacing-sm);
      align-items: center;
    }

    .menu-card {
      background: white;
      padding: var(--spacing-sm) var(--spacing-md);
      border-radius: var(--border-radius);
      cursor: pointer;
      transition: all 0.3s ease;
      border: 2px solid transparent;
      font-weight: 600;
      text-decoration: none;
      color: var(--text-primary);
      display: flex;
      align-items: center;
      gap: var(--spacing-xs);
    }

    .menu-card:hover {
      transform: translateY(-2px);
      border-color: var(--primary-color);
      box-shadow: 0 4px 12px rgba(0, 122, 255, 0.15);
    }

    .menu-card.active {
      background: var(--primary-color);
      color: white;
    }

    .nav-actions {
      display: flex;
      gap: var(--spacing-sm);
      align-items: center;
    }

    .btn {
      padding: 0.75rem 1.5rem;
      border: none;
      border-radius: var(--border-radius);
      font-size: 1rem;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.3s ease;
      display: inline-flex;
      align-items: center;
      gap: var(--spacing-xs);
      text-decoration: none;
    }

    .btn-primary {
      background: var(--primary-color);
      color: white;
    }

    .btn-primary:hover {
      background: var(--primary-dark);
      transform: translateY(-2px);
      box-shadow: 0 4px 12px rgba(0, 122, 255, 0.3);
    }

    .btn-secondary {
      background: rgba(255, 255, 255, 0.2);
      color: var(--text-white);
      border: 1px solid rgba(255, 255, 255, 0.3);
    }

    .btn-secondary:hover {
      background: rgba(255, 255, 255, 0.3);
      transform: translateY(-2px);
    }

    .btn-sm {
      padding: 0.5rem 1rem;
      font-size: 0.875rem;
    }

    .card {
      margin-bottom: 1rem;
      border: none;
      border-radius: var(--border-radius);
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
    }

    .card-body {
      padding: var(--spacing-lg);
    }

    .small-muted {
      font-size: 0.85rem;
      color: var(--text-secondary);
    }

    .required::after {
      content: " *";
      color: var(--error-color);
    }

    .table-fixed {
      max-height: 240px;
      overflow: auto;
      display: block;
    }

    .watermark {
      position: fixed;
      right: 10px;
      bottom: 10px;
      opacity: 0.12;
      font-weight: 700;
      font-size: 12px;
      color: var(--text-primary);
    }

    .form-container {
      max-width: 100%;
      margin: 0 auto;
    }

    .form-section {
      background: white;
      border-radius: var(--border-radius);
      padding: var(--spacing-lg);
      margin-bottom: var(--spacing-lg);
    }

    .form-title {
      font-size: 1.5rem;
      font-weight: 700;
      margin-bottom: var(--spacing-md);
      color: var(--text-primary);
      border-bottom: 2px solid var(--primary-color);
      padding-bottom: var(--spacing-xs);
    }

    .form-group {
      margin-bottom: var(--spacing-md);
    }

    .form-row {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: var(--spacing-md);
    }

    .form-label {
      display: block;
      margin-bottom: var(--spacing-xs);
      font-weight: 600;
      color: var(--text-primary);
    }

    .form-input, .form-select, .form-textarea {
      width: 100%;
      padding: 0.75rem;
      border: 2px solid #E5E5EA;
      border-radius: var(--border-radius);
      font-size: 1rem;
      transition: all 0.3s ease;
      background: white;
    }

    .form-input:focus, .form-select:focus, .form-textarea:focus {
      outline: none;
      border-color: var(--primary-color);
      box-shadow: 0 0 0 3px rgba(0, 122, 255, 0.1);
    }

    .form-textarea {
      resize: vertical;
      min-height: 100px;
    }

    .input-with-button {
      display: flex;
      gap: var(--spacing-sm);
    }

    .input-with-button .form-input {
      flex: 1;
    }

    .stats-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
      gap: var(--spacing-md);
      margin-bottom: var(--spacing-lg);
    }

    .stat-card {
      background: white;
      padding: var(--spacing-lg);
      border-radius: var(--border-radius);
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
      text-align: center;
    }

    .stat-number {
      font-size: 2.5rem;
      font-weight: 700;
      color: var(--primary-color);
      margin-bottom: var(--spacing-xs);
    }

    .stat-label {
      font-size: 1rem;
      color: var(--text-secondary);
      font-weight: 600;
    }

    .team-overview {
      background: white;
      padding: var(--spacing-lg);
      border-radius: var(--border-radius);
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
      margin-bottom: var(--spacing-lg);
    }

    .team-scroll {
      display: flex;
      gap: var(--spacing-md);
      overflow-x: auto;
      padding: var(--spacing-md) 0;
    }

    .trainer-card {
      flex: 0 0 auto;
      text-align: center;
      padding: var(--spacing-md);
      border: 2px solid transparent;
      border-radius: var(--border-radius);
      transition: all 0.3s ease;
      cursor: pointer;
      min-width: 120px;
    }

    .trainer-card:hover {
      border-color: var(--primary-color);
      transform: translateY(-2px);
    }

    .trainer-avatar {
      width: 60px;
      height: 60px;
      border-radius: 50%;
      background: var(--primary-color);
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 1.5rem;
      margin: 0 auto var(--spacing-xs);
      color: white;
    }

    .trainer-stats {
      display: flex;
      justify-content: center;
      gap: var(--spacing-sm);
      margin-top: var(--spacing-xs);
    }

    .stat-badge {
      background: var(--primary-color);
      color: white;
      padding: 0.25rem 0.5rem;
      border-radius: 20px;
      font-size: 0.75rem;
      font-weight: 600;
    }

    .notification-badge {
      position: absolute;
      top: -5px;
      right: -5px;
      background: var(--error-color);
      color: white;
      border-radius: 50%;
      width: 20px;
      height: 20px;
      font-size: 0.75rem;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .modal-overlay {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0, 0, 0, 0.5);
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 2000;
      padding: var(--spacing-lg);
    }

    .modal-content {
      background: white;
      border-radius: var(--border-radius-lg);
      padding: var(--spacing-lg);
      max-width: 500px;
      width: 100%;
      max-height: 90vh;
      overflow-y: auto;
      box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
    }

    .modal-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: var(--spacing-md);
      padding-bottom: var(--spacing-sm);
      border-bottom: 1px solid #E5E5EA;
    }

    .modal-title {
      font-size: 1.25rem;
      font-weight: 700;
      color: var(--text-primary);
    }

    .modal-close {
      background: none;
      border: none;
      font-size: 1.5rem;
      cursor: pointer;
      color: var(--text-secondary);
    }

    .form-subsection {
      background: #f8f9fa;
      border-radius: 8px;
      padding: 1.5rem;
      margin-bottom: 1rem;
      border-left: 4px solid var(--primary-color);
    }
    
    .subsection-title {
      font-size: 1.1rem;
      font-weight: 600;
      margin-bottom: 1rem;
      color: #333;
      display: flex;
      align-items: center;
      gap: 0.5rem;
    }
    
    .financial-products {
      display: flex;
      flex-direction: column;
      gap: 1rem;
    }
    
    .product-item {
      display: flex;
      align-items: center;
      gap: 1rem;
      padding: 0.75rem;
      background: white;
      border-radius: 8px;
      border: 1px solid #e0e0e0;
    }
    
    .product-checkbox {
      display: flex;
      align-items: center;
      gap: 0.5rem;
      min-width: 150px;
    }
    
    .product-inputs {
      display: flex;
      gap: 1rem;
      flex: 1;
    }
    
    .children-list {
      display: flex;
      flex-direction: column;
      gap: 1rem;
    }
    
    .child-item {
      display: flex;
      gap: 1rem;
      align-items: center;
      padding: 1rem;
      background: white;
      border-radius: 8px;
      border: 1px solid #e0e0e0;
    }
    
    .add-button {
      background: var(--success-color);
      color: white;
      border: none;
      padding: 0.5rem 1rem;
      border-radius: 6px;
      cursor: pointer;
      display: flex;
      align-items: center;
      gap: 0.5rem;
      font-size: 0.875rem;
    }
    
    .remove-button {
      background: var(--error-color);
      color: white;
      border: none;
      padding: 0.25rem 0.5rem;
      border-radius: 4px;
      cursor: pointer;
    }
    
    .unknown-checkbox {
      display: flex;
      align-items: center;
      gap: 0.5rem;
      margin-top: 0.5rem;
      font-size: 0.875rem;
      color: #666;
    }

    .comment-section {
      margin-top: 1rem;
      padding: 1rem;
      background: #f8f9fa;
      border-radius: 8px;
    }

    .comment {
      padding: 0.75rem;
      background: white;
      border-radius: 8px;
      margin-bottom: 0.5rem;
      border-left: 3px solid var(--primary-color);
    }

    .comment-header {
      display: flex;
      justify-content: space-between;
      font-size: 0.875rem;
      color: var(--text-secondary);
      margin-bottom: 0.25rem;
    }

    .charts-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
      gap: var(--spacing-lg);
      margin-bottom: var(--spacing-lg);
    }

    .chart-container {
      background: white;
      padding: var(--spacing-lg);
      border-radius: var(--border-radius);
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
    }

    .chart-title {
      font-size: 1.1rem;
      font-weight: 600;
      margin-bottom: 1rem;
      text-align: center;
    }

    .simple-chart {
      height: 200px;
      display: flex;
      align-items: end;
      justify-content: center;
      gap: 0.5rem;
      padding: 1rem;
    }

    .chart-bar {
      background: var(--primary-color);
      border-radius: 4px 4px 0 0;
      min-width: 40px;
      position: relative;
      transition: all 0.3s ease;
    }

    .chart-bar:hover {
      background: var(--primary-dark);
    }

    .chart-label {
      position: absolute;
      bottom: -25px;
      left: 50%;
      transform: translateX(-50%);
      font-size: 0.75rem;
      color: var(--text-secondary);
      text-align: center;
    }

    .chart-value {
      position: absolute;
      top: -25px;
      left: 50%;
      transform: translateX(-50%);
      font-size: 0.875rem;
      font-weight: 600;
      color: var(--text-primary);
    }

    .filter-section {
      background: white;
      padding: var(--spacing-md);
      border-radius: var(--border-radius);
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
      margin-bottom: var(--spacing-lg);
      display: flex;
      gap: var(--spacing-md);
      flex-wrap: wrap;
      align-items: end;
    }

    .filter-group {
      display: flex;
      flex-direction: column;
      gap: 0.5rem;
    }

    .filter-label {
      font-size: 0.875rem;
      font-weight: 600;
      color: var(--text-secondary);
    }

    .loading-spinner {
      display: inline-block;
      width: 20px;
      height: 20px;
      border: 3px solid rgba(255, 255, 255, 0.3);
      border-radius: 50%;
      border-top-color: white;
      animation: spin 1s ease-in-out infinite;
    }

    @keyframes spin {
      to { transform: rotate(360deg); }
    }

    .last-update {
      font-size: 0.875rem;
      color: var(--text-secondary);
      margin-top: 0.5rem;
      padding: 0.5rem;
      background: #f8f9fa;
      border-radius: 6px;
    }

    @media (max-width: 768px) {
      .form-row {
        grid-template-columns: 1fr;
      }
      
      .main-nav {
        flex-direction: column;
        gap: var(--spacing-md);
      }
      
      .nav-menu {
        flex-wrap: wrap;
        justify-content: center;
      }
      
      .stats-grid {
        grid-template-columns: 1fr;
      }
      
      .filter-section {
        flex-direction: column;
        align-items: stretch;
      }
    }
  </style>
</head>
<body>
  <div class="app-container glass-container">
    <!-- Navigation -->
    <nav class="main-nav">
      <div class="nav-brand">
        <i class="fas fa-chart-line"></i>
        Account Planning System
      </div>
      <div class="nav-menu">
        <button class="menu-card active" id="tab-form">
          <i class="fas fa-user-plus"></i> Create / Edit Customer
        </button>
        <button class="menu-card" id="tab-list">
          <i class="fas fa-list"></i> Customer List & Search
        </button>
        <button class="menu-card" id="tab-report">
          <i class="fas fa-chart-bar"></i> Reports (Passcode)
          <span class="notification-badge" id="report-notification" style="display: none;">!</span>
        </button>
        <button class="menu-card" id="tab-admin">
          <i class="fas fa-cog"></i> Admin / Audit
        </button>
      </div>
      <div class="nav-actions">
        <button class="btn btn-sm btn-secondary" id="btn-team-view">
          <i class="fas fa-users"></i> Team View
        </button>
        <button class="btn btn-sm btn-secondary" id="btn-logout">
          <i class="fas fa-sign-out-alt"></i> ออกจากระบบ
        </button>
      </div>
    </nav>

    <!-- Main Content -->
    <div id="content" class="flex-grow-1">
      
      <!-- FORM PANEL -->
      <div id="panel-form" class="card">
        <div class="card-body">
          <h3 class="form-title">ฟอร์มกรอกข้อมูลลูกค้า</h3>
          <p class="small-muted mb-3">กรอกข้อมูลให้ครบ — ระบบจะสร้าง Customer ID อัตโนมัติ</p>

          <form id="customerForm" class="row g-3">
            <!-- Employee Information -->
            <div class="form-subsection">
              <div class="subsection-title">
                <i class="fas fa-user-tie"></i> ข้อมูลพนักงาน
              </div>
              <div class="form-row">
                <div class="form-group">
                  <label class="form-label required">ชื่อพนักงาน</label>
                  <input type="text" id="employee_name" class="form-control" placeholder="ชื่อผู้กรอก (เช่น Somchai)">
                </div>
                <div class="form-group">
                  <label class="form-label required">รหัสพนักงาน</label>
                  <input type="text" id="employee_id" class="form-control" placeholder="BR1234">
                </div>
              </div>
              <div class="form-row">
                <div class="form-group">
                  <label class="form-label required">Branch</label>
                  <input type="text" id="branch" class="form-control" placeholder="Bangkok Central">
                </div>
                <div class="form-group">
                  <label class="form-label">Zone</label>
                  <input type="text" id="zone" class="form-control" placeholder="Zone A">
                </div>
                <div class="form-group">
                  <label class="form-label required">RH (RH1-RH5)</label>
                  <select id="rh" class="form-select">
                    <option value="">เลือก RH</option>
                    <option>RH1</option>
                    <option>RH2</option>
                    <option>RH3</option>
                    <option>RH4</option>
                    <option>RH5</option>
                  </select>
                </div>
              </div>
            </div>

            <!-- Customer Personal Information -->
            <div class="form-subsection">
              <div class="subsection-title">
                <i class="fas fa-user"></i> ข้อมูลส่วนตัวลูกค้า
              </div>
              <div class="form-row">
                <div class="form-group">
                  <label class="form-label required">ชื่อ</label>
                  <input type="text" id="cust_first" class="form-control" placeholder="ชื่อ">
                </div>
                <div class="form-group">
                  <label class="form-label required">นามสกุล</label>
                  <input type="text" id="cust_last" class="form-control" placeholder="นามสกุล">
                </div>
              </div>
              <div class="form-row">
                <div class="form-group">
                  <label class="form-label">เบอร์โทรศัพท์</label>
                  <input type="tel" id="cust_phone" class="form-control" placeholder="0812345678">
                </div>
                <div class="form-group">
                  <label class="form-label">อีเมล</label>
                  <input type="email" id="cust_email" class="form-control" placeholder="example@domain.com">
                </div>
              </div>
              <div class="form-group">
                <label class="form-label">ที่อยู่</label>
                <textarea id="cust_address" rows="2" class="form-control" placeholder="ที่อยู่"></textarea>
              </div>
            </div>

            <!-- Family Information -->
            <div class="form-subsection">
              <div class="subsection-title">
                <i class="fas fa-users"></i> ข้อมูลครอบครัว
              </div>
              <div class="form-row">
                <div class="form-group">
                  <label class="form-label">วันเกิด</label>
                  <input type="date" id="cust_dob" class="form-control">
                </div>
                <div class="form-group">
                  <label class="form-label">สถานภาพสมรส</label>
                  <select id="cust_marital" class="form-select">
                    <option value="">เลือกสถานภาพ</option>
                    <option>โสด</option>
                    <option>สมรส</option>
                    <option>หย่า</option>
                    <option>หม้าย</option>
                  </select>
                </div>
              </div>
              <div class="form-group">
                <label class="form-label">ผู้ร่วมอาศัย</label>
                <textarea id="cust_household" class="form-control" placeholder="เช่น อาศัยกับ: แม่, ภรรยา, ลูก 2 คน (อายุ)"></textarea>
              </div>
              <div class="form-row">
                <div class="form-group">
                  <label class="form-label">อาชีพ / ธุรกิจ</label>
                  <input type="text" id="cust_occupation" class="form-control" placeholder="วิศวกร / เจ้าของกิจการ">
                </div>
                <div class="form-group">
                  <label class="form-label">รายได้จริง / เดือน (บาท)</label>
                  <input type="number" id="cust_income" class="form-control" placeholder="30000">
                  <div class="unknown-checkbox">
                    <input type="checkbox" id="unknown_income">
                    <label for="unknown_income">ไม่มีข้อมูล หรือ ไม่ทราบข้อมูล</label>
                  </div>
                </div>
              </div>
            </div>

            <!-- Products -->
            <div class="form-subsection">
              <div class="subsection-title">
                <i class="fas fa-box"></i> ผลิตภัณฑ์ที่มีอยู่
              </div>
              <div class="form-group">
                <label class="form-label">ผลิตภัณฑ์ที่มีอยู่ (เพิ่มได้หลายรายการ)</label>
                <div class="d-flex gap-2 mb-2">
                  <input type="text" id="prod_name" class="form-control" placeholder="ชื่อผลิตภัณฑ์ (เช่น ABC Life 20Y)">
                  <input type="number" id="prod_sum" class="form-control" placeholder="Sum Assured / มูลค่า">
                  <input type="number" id="prod_premium" class="form-control" placeholder="เบี้ย/ปี">
                  <button type="button" id="btnAddProd" class="btn btn-outline-primary">เพิ่ม</button>
                </div>
                <div id="prodList" class="mb-2"></div>
              </div>
            </div>

            <!-- Opportunity -->
            <div class="form-subsection">
              <div class="subsection-title">
                <i class="fas fa-bullseye"></i> โอกาสทางธุรกิจ
              </div>
              <div class="form-row">
                <div class="form-group">
                  <label class="form-label">Opportunity Type</label>
                  <select id="opp_type" class="form-select">
                    <option value="">เลือกประเภท</option>
                    <option>Protection</option>
                    <option>Wealth</option>
                    <option>Health</option>
                    <option>Savings</option>
                  </select>
                </div>
                <div class="form-group">
                  <label class="form-label">Estimated Value (THB)</label>
                  <input type="number" id="opp_value" class="form-control" placeholder="ประมาณมูลค่า">
                </div>
                <div class="form-group">
                  <label class="form-label">Status</label>
                  <select id="opp_status" class="form-select">
                    <option value="">เลือกสถานะ</option>
                    <option>Open</option>
                    <option>In-progress</option>
                    <option>Closed</option>
                  </select>
                </div>
              </div>
              <div class="form-group">
                <label class="form-label">ความคิดเห็นของพนักงาน (1-2 ประโยค)</label>
                <textarea id="opp_comment" rows="2" class="form-control" placeholder="ความคิดเห็นเกี่ยวกับโอกาสทางธุรกิจ"></textarea>
              </div>
            </div>

            <!-- Attachments -->
            <div class="form-subsection">
              <div class="subsection-title">
                <i class="fas fa-paperclip"></i> ไฟล์แนบ
              </div>
              <div class="form-group">
                <label class="form-label">Attach file (PDF/JPG/PNG)</label>
                <input type="file" id="file_attach" class="form-control">
                <div id="attachList" class="mt-2"></div>
              </div>
            </div>

            <!-- Consent -->
            <div class="form-group">
              <div class="form-check">
                <input class="form-check-input" type="checkbox" id="consent" checked>
                <label class="form-check-label small-muted" for="consent">
                  ลูกค้ายินยอมให้เก็บข้อมูลสำหรับการนำเสนอผลิตภัณฑ์ (Consent recorded)
                </label>
              </div>
            </div>

            <!-- Buttons -->
            <div class="col-12 d-flex gap-2">
              <button type="button" id="btnSave" class="btn btn-primary">
                <i class="fas fa-save"></i> บันทึกข้อมูล (Create)
              </button>
              <button type="button" id="btnClear" class="btn btn-secondary">
                <i class="fas fa-broom"></i> ล้างฟอร์ม
              </button>
              <div class="ms-auto small-muted align-self-center" id="formStatus"></div>
            </div>
          </form>
        </div>
      </div>

      <!-- LIST / SEARCH PANEL -->
      <div id="panel-list" class="card" style="display:none;">
        <div class="card-body">
          <h3 class="form-title">รายการลูกค้า / ค้นหา</h3>
          <div class="filter-section">
            <div class="filter-group">
              <div class="filter-label">ค้นหาลูกค้า</div>
              <input type="text" id="search_customer" class="form-control" placeholder="Search Customer ID หรือชื่อ">
            </div>
            <div class="filter-group">
              <div class="filter-label">ค้นหาตามพนักงาน</div>
              <input type="text" id="search_by_creator" class="form-control" placeholder="Search by Employee ID">
            </div>
            <div class="filter-group">
              <div class="filter-label">Filter RH</div>
              <select id="filter_rh" class="form-select">
                <option value="">ทั้งหมด</option>
                <option>RH1</option>
                <option>RH2</option>
                <option>RH3</option>
                <option>RH4</option>
                <option>RH5</option>
              </select>
            </div>
            <div class="filter-group">
              <div class="filter-label">Filter Branch</div>
              <input type="text" id="filter_branch" class="form-control" placeholder="Filter by Branch">
            </div>
            <div class="d-flex gap-2 align-items-end">
              <button class="btn btn-outline-primary" id="btnSearch">
                <i class="fas fa-search"></i> ค้นหา
              </button>
              <button class="btn btn-outline-secondary" id="btnRefresh">
                <i class="fas fa-sync-alt"></i> รีเฟรชทั้งหมด
              </button>
            </div>
          </div>

          <div class="d-flex justify-content-between align-items-center mb-3">
            <div class="small-muted" id="searchResultsCount"></div>
            <div>
              <button class="btn btn-outline-success btn-sm" id="btnBulkExport">
                <i class="fas fa-file-pdf"></i> Export Selected → PDF
              </button>
              <button class="btn btn-outline-info btn-sm" id="btnExportCSVList">
                <i class="fas fa-file-csv"></i> Export CSV
              </button>
            </div>
          </div>

          <div class="table-responsive table-fixed">
            <table class="table table-striped" id="customerTable">
              <thead class="table-light">
                <tr>
                  <th><input type="checkbox" id="selectAll"></th>
                  <th>Customer ID</th>
                  <th>Name</th>
                  <th>Branch</th>
                  <th>RH</th>
                  <th>Created By</th>
                  <th>Created At</th>
                  <th>Actions</th>
                </tr>
              </thead>
              <tbody id="customerTbody"></tbody>
            </table>
          </div>
        </div>
      </div>

      <!-- REPORTS PANEL -->
      <div id="panel-report" class="card" style="display:none;">
        <div class="card-body">
          <h3 class="form-title">รายงาน / Dashboard (Passcode protected)</h3>
          
          <div id="reportLocked" class="mb-4">
            <p class="small-muted">กรุณาใส่ Passcode เพื่อเข้าใช้งานเมนูรายงาน</p>
            <div class="d-flex gap-2 align-items-end">
              <div class="flex-grow-1">
                <label class="form-label">Passcode</label>
                <input type="password" id="reportPass" class="form-control" placeholder="Passcode">
              </div>
              <button id="btnUnlock" class="btn btn-primary">
                <i class="fas fa-lock-open"></i> Unlock
              </button>
            </div>
            <div class="mt-2 small-muted">
              (default demo passcode: <strong>2568</strong>)
            </div>
            <div class="form-text small text-danger mt-1">
              คำเตือน: passcode คงที่ไม่ปลอดภัยสำหรับ production — เปลี่ยนเป็น SSO/temporary token
            </div>
          </div>

          <div id="reportPanel" style="display:none;">
            <div class="filter-section">
              <div class="filter-group">
                <div class="filter-label">Region</div>
                <select id="filter_report_region" class="form-select">
                  <option value="all">ทั้งหมด</option>
                  <option>RH1</option>
                  <option>RH2</option>
                  <option>RH3</option>
                  <option>RH4</option>
                  <option>RH5</option>
                </select>
              </div>
              <div class="filter-group">
                <div class="filter-label">วันที่เริ่ม</div>
                <input type="date" id="filter_start_date" class="form-control">
              </div>
              <div class="filter-group">
                <div class="filter-label">วันที่สิ้นสุด</div>
                <input type="date" id="filter_end_date" class="form-control">
              </div>
              <div class="filter-group">
                <div class="filter-label">ตำแหน่ง</div>
                <select id="filter_report_position" class="form-select">
                  <option value="">ทั้งหมด</option>
                  <option>BM</option>
                  <option>WCRM</option>
                  <option>CISA</option>
                  <option>CFSA</option>
                  <option>IA</option>
                  <option>IS</option>
                </select>
              </div>
              <button class="btn btn-secondary" id="btnApplyFilters">
                <i class="fas fa-filter"></i> Apply Filters
              </button>
            </div>

            <div class="stats-grid">
              <div class="stat-card">
                <div class="stat-number" id="kpi_total">0</div>
                <div class="stat-label">Total Cases MTD</div>
              </div>
              <div class="stat-card">
                <div class="stat-number" id="kpi_opp_count">0</div>
                <div class="stat-label">New Opportunities MTD</div>
              </div>
              <div class="stat-card">
                <div class="stat-number" id="kpi_opp_value">0</div>
                <div class="stat-label">Est. Opportunity Value (MTD)</div>
              </div>
              <div class="stat-card">
                <div class="stat-number" id="kpi_top_branch">-</div>
                <div class="stat-label">Top Branch (cases)</div>
              </div>
            </div>

            <div class="charts-grid">
              <div class="chart-container">
                <div class="chart-title">Cases by RH</div>
                <canvas id="chartRh" height="200"></canvas>
              </div>
              <div class="chart-container">
                <div class="chart-title">Top Branches</div>
                <canvas id="chartBranch" height="200"></canvas>
              </div>
            </div>

            <div class="team-overview">
              <div class="d-flex justify-content-between align-items-center mb-3">
                <h4>Team Overview</h4>
                <button class="btn btn-sm btn-secondary" id="btnRefreshTeam">Refresh</button>
              </div>
              <div class="team-scroll" id="teamScroll"></div>
            </div>

            <div class="d-flex gap-2 mt-4">
              <button id="btnExportAll" class="btn btn-outline-primary">
                <i class="fas fa-file-pdf"></i> Export All → Multi-page PDF
              </button>
              <button id="btnExportCSV" class="btn btn-outline-secondary">
                <i class="fas fa-file-csv"></i> Export CSV
              </button>
            </div>
          </div>
        </div>
      </div>

      <!-- ADMIN PANEL -->
      <div id="panel-admin" class="card" style="display:none;">
        <div class="card-body">
          <h3 class="form-title">Admin / Audit</h3>
          <p class="small-muted mb-3">Audit log (view only) — บันทึกการสร้าง แก้ไข และ export</p>
          
          <div class="d-flex gap-2 mb-3">
            <button class="btn btn-sm btn-outline-primary" id="btnRefreshAudit">
              <i class="fas fa-sync-alt"></i> Refresh Logs
            </button>
            <button class="btn btn-sm btn-outline-secondary" id="btnExportAudit">
              <i class="fas fa-download"></i> Export Audit Log
            </button>
          </div>
          
          <div id="auditList" class="small-muted"></div>
          
          <div class="mt-4 p-3 border rounded">
            <h5 class="text-danger mb-3">
              <i class="fas fa-exclamation-triangle"></i> Danger Zone
            </h5>
            <button id="btnResetAll" class="btn btn-danger">
              <i class="fas fa-trash-alt"></i> Reset all data (localStorage)
            </button>
            <div class="form-text small text-danger mt-1">
              ใช้ใน demo เท่านั้น — จะลบข้อมูลทุกอย่างในระบบ
            </div>
          </div>
        </div>
      </div>
    </div>

    <div class="watermark">Enhanced Account Planning System</div>
  </div>

  <script>
    /**************************************************************************
     * Enhanced Account Planning System
     * Combined features from both systems with improved UI/UX
     * Storage: localStorage
     * Passcode for report: '2568'
     * Enhanced with Glass morphism UI, Collaboration, and Advanced Reporting
     **************************************************************************/

    // ---------- Constants and Utilities ----------
    const STORAGE_KEY = 'aps_customers';
    const AUDIT_KEY = 'aps_audit';
    const COUNTER_KEY = 'aps_counters';
    const REPORT_PASSCODE = '2568';
    const REGIONS = ['RH1', 'RH2', 'RH3', 'RH4', 'RH5'];
    const POSITIONS = ['BM', 'WCRM', 'CISA', 'CFSA', 'IA', 'IS', 'อื่น ๆ'];

    // DOM Helper
    const $ = (id) => document.getElementById(id);

    // Date and Time Utilities
    function nowISO() {
      return new Date().toISOString();
    }

    function formatDateISOToLocalShort(iso) {
      if (!iso) return '';
      const d = new Date(iso);
      return d.toLocaleString('th-TH', { 
        year: 'numeric', 
        month: 'short', 
        day: 'numeric', 
        hour: '2-digit', 
        minute: '2-digit' 
      });
    }

    // Data Management
    function loadData() {
      try {
        const raw = localStorage.getItem(STORAGE_KEY);
        return raw ? JSON.parse(raw) : [];
      } catch(e) { 
        console.error('Error loading data:', e);
        return []; 
      }
    }

    function saveData(arr) { 
      localStorage.setItem(STORAGE_KEY, JSON.stringify(arr)); 
    }

    function loadAudit() {
      try { 
        return JSON.parse(localStorage.getItem(AUDIT_KEY) || '[]'); 
      } catch(e) { 
        console.error('Error loading audit:', e);
        return []; 
      }
    }

    function saveAudit(a) { 
      localStorage.setItem(AUDIT_KEY, JSON.stringify(a)); 
    }

    function appendAudit(action, entityId, performedBy, data = null) {
      const a = loadAudit();
      a.unshift({ 
        action, 
        entity: entityId, 
        performed_by: performedBy, 
        time: nowISO(), 
        data 
      });
      saveAudit(a);
      renderAuditList(); // Refresh audit display
    }

    // Customer Code Generation
    function genCustomerCode() {
      const counters = JSON.parse(localStorage.getItem(COUNTER_KEY) || '{}');
      const dateKey = new Date().toISOString().slice(0,10).replace(/-/g,'');
      counters[dateKey] = (counters[dateKey] || 0) + 1;
      localStorage.setItem(COUNTER_KEY, JSON.stringify(counters));
      const seq = String(counters[dateKey]).padStart(4,'0');
      return `CUST${dateKey}-${seq}`;
    }

    // ---------- Products and Attachments Management ----------
    let tmpProducts = [];
    let tmpAttachments = [];

    function renderProdList() {
      const container = $('prodList');
      container.innerHTML = tmpProducts.map((p, idx) => `
        <div class="d-flex align-items-center mb-2 p-2 border rounded" data-idx="${idx}">
          <div class="me-auto">
            <strong>${p.product_name || ''}</strong>
            <div class="small-muted">Sum: ${p.sum_assured || 0} | Premium: ${p.premium || 0}</div>
          </div>
          <button class="btn btn-sm btn-outline-danger" onclick="removeProd(${idx})">
            <i class="fas fa-trash"></i> ลบ
          </button>
        </div>
      `).join('') || '<div class="text-muted p-2 border rounded">ยังไม่มีผลิตภัณฑ์</div>';
    }

    function renderAttachList() {
      const container = $('attachList');
      container.innerHTML = tmpAttachments.map((f, idx) => `
        <div class="d-flex align-items-center mb-2 p-2 border rounded">
          <div class="me-auto small-muted">
            <i class="fas fa-file"></i> ${f.name} (${f.type})
          </div>
          <button class="btn btn-sm btn-outline-danger" onclick="removeAttach(${idx})">
            <i class="fas fa-trash"></i> ลบ
          </button>
        </div>
      `).join('') || '<div class="text-muted p-2 border rounded">ยังไม่มีไฟล์แนบ</div>';
    }

    // ---------- Form Management ----------
    function clearForm() {
      document.getElementById('customerForm').reset();
      tmpProducts = []; 
      tmpAttachments = [];
      renderProdList(); 
      renderAttachList();
      $('formStatus').textContent = '';
    }

    function validateForm() {
      const required = [
        ['employee_name', 'กรอกชื่อผู้กรอก'],
        ['employee_id', 'กรอก Employee ID'],
        ['branch', 'กรอก Branch'],
        ['cust_first', 'กรอกชื่อ'],
        ['cust_last', 'กรอกนามสกุล'],
        ['rh', 'เลือก RH']
      ];

      for (let [id, msg] of required) {
        const el = $(id);
        if (!el) continue;
        if (!el.value || el.value.trim() === '') {
          showNotification(msg, 'error');
          el.focus();
          return false;
        }
      }
      return true;
    }

    function showNotification(message, type = 'info') {
      // Create notification element
      const notification = document.createElement('div');
      notification.className = `alert alert-${type === 'error' ? 'danger' : type} alert-dismissible fade show`;
      notification.innerHTML = `
        ${message}
        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
      `;
      
      // Add to page
      document.body.appendChild(notification);
      
      // Auto remove after 5 seconds
      setTimeout(() => {
        if (notification.parentNode) {
          notification.remove();
        }
      }, 5000);
    }

    // ---------- Customer Data Management ----------
    function saveCustomer() {
      if (!validateForm()) return;

      const createdBy = $('employee_id').value.trim();
      const empName = $('employee_name').value.trim();
      const branch = $('branch').value.trim();
      const zone = $('zone').value.trim();
      const rh = $('rh').value.trim();

      const customer = {
        customer_id: genCustomerCode(),
        first_name: $('cust_first').value.trim(),
        last_name: $('cust_last').value.trim(),
        phone: $('cust_phone').value.trim(),
        email: $('cust_email').value.trim(),
        address: $('cust_address').value.trim(),
        dob: $('cust_dob').value || null,
        marital_status: $('cust_marital').value.trim(),
        household: $('cust_household').value.trim(),
        occupation: $('cust_occupation').value.trim(),
        monthly_income: Number($('cust_income').value || 0),
        branch, 
        zone, 
        rh,
        products: [...tmpProducts],
        opportunities: [{
          type: $('opp_type').value || null,
          estimated_value: Number($('opp_value').value || 0),
          status: $('opp_status').value || null,
          comment: $('opp_comment').value.trim(),
          created_at: nowISO(),
          created_by: createdBy
        }],
        attachments: [...tmpAttachments],
        created_by: createdBy,
        created_by_name: empName,
        consent: !!$('consent').checked,
        created_at: nowISO(),
        updated_at: nowISO(),
        comments: [] // For collaboration
      };

      const all = loadData();
      all.unshift(customer);
      saveData(all);
      
      appendAudit('create', customer.customer_id, createdBy, { 
        first_name: customer.first_name, 
        branch 
      });
      
      clearForm();
      $('formStatus').textContent = `บันทึกเรียบร้อย: ${customer.customer_id}`;
      showNotification(`บันทึกข้อมูลลูกค้า ${customer.customer_id} เรียบร้อยแล้ว`, 'success');
      
      refreshList();
      if (window.reportUnlocked) renderReport();
    }

    // ---------- List and Search Functionality ----------
    function renderTableRows(list) {
      const tbody = $('customerTbody');
      const countElement = $('searchResultsCount');
      
      countElement.textContent = `พบทั้งหมด ${list.length} รายการ`;
      
      tbody.innerHTML = list.map(c => `
        <tr>
          <td><input type="checkbox" class="rowSelect" data-id="${c.customer_id}"></td>
          <td>
            <strong>${c.customer_id}</strong>
            ${c.comments && c.comments.length > 0 ? 
              '<span class="badge bg-info ms-1" title="มีความคิดเห็น"><i class="fas fa-comment"></i></span>' : ''}
          </td>
          <td>${c.first_name} ${c.last_name}</td>
          <td>${c.branch || '-'}</td>
          <td><span class="badge bg-primary">${c.rh || '-'}</span></td>
          <td>${c.created_by || '-'}</td>
          <td>${formatDateISOToLocalShort(c.created_at)}</td>
          <td>
            <div class="btn-group btn-group-sm">
              <button class="btn btn-outline-primary" onclick="viewDetail('${c.customer_id}')" title="View">
                <i class="fas fa-eye"></i>
              </button>
              <button class="btn btn-outline-secondary" onclick="exportSinglePDF('${c.customer_id}')" title="PDF">
                <i class="fas fa-file-pdf"></i>
              </button>
              <button class="btn btn-outline-info" onclick="addComment('${c.customer_id}')" title="Comment">
                <i class="fas fa-comment"></i>
              </button>
              <button class="btn btn-outline-danger" onclick="deleteRecord('${c.customer_id}')" title="Delete">
                <i class="fas fa-trash"></i>
              </button>
            </div>
          </td>
        </tr>
      `).join('') || '<tr><td colspan="8" class="text-center text-muted py-3">ไม่มีข้อมูลลูกค้า</td></tr>';
    }

    function refreshList() {
      const all = loadData();
      renderTableRows(all);
    }

    function searchCustomers() {
      const q = $('search_customer').value.trim().toLowerCase();
      const by = $('search_by_creator').value.trim().toLowerCase();
      const rh = $('filter_rh').value.trim();
      const branch = $('filter_branch').value.trim().toLowerCase();
      
      let all = loadData();
      
      if (q) {
        all = all.filter(c => 
          c.customer_id.toLowerCase().includes(q) || 
          (c.first_name + ' ' + c.last_name).toLowerCase().includes(q)
        );
      }
      
      if (by) {
        all = all.filter(c => 
          (c.created_by || '').toLowerCase().includes(by) || 
          (c.created_by_name || '').toLowerCase().includes(by)
        );
      }
      
      if (rh) {
        all = all.filter(c => (c.rh || '') === rh);
      }
      
      if (branch) {
        all = all.filter(c => (c.branch || '').toLowerCase().includes(branch));
      }
      
      renderTableRows(all);
    }

    // ---------- PDF Export Functions ----------
    async function exportSinglePDF(customerId) {
      const all = loadData();
      const c = all.find(x => x.customer_id === customerId);
      if (!c) {
        showNotification('ไม่พบข้อมูลลูกค้า', 'error');
        return;
      }
      
      // Verify employee access
      const employeeId = prompt('กรุณากรอกรหัสพนักงานเพื่อยืนยันตัวตน:');
      if (!employeeId || employeeId.trim() !== c.created_by) {
        showNotification('รหัสพนักงานไม่ถูกต้อง', 'error');
        return;
      }
      
      await exportMultiplePDF([c]);
      appendAudit('export_pdf', customerId, 'local-user', null);
      showNotification(`Export PDF สำหรับ ${customerId} เรียบร้อยแล้ว`, 'success');
    }

    async function exportMultiplePDF(items) {
      if (!items || items.length === 0) {
        showNotification('ไม่มีข้อมูลสำหรับ export', 'warning');
        return;
      }
      
      const { jsPDF } = window.jspdf;
      const doc = new jsPDF({ unit: 'px', format: 'a4' });
      
      for (let i = 0; i < items.length; i++) {
        const c = items[i];
        const wrapper = document.createElement('div');
        wrapper.style.width = '794px';
        wrapper.style.padding = '20px';
        wrapper.style.background = '#fff';
        wrapper.style.fontFamily = 'Arial, Helvetica, sans-serif';
        
        wrapper.innerHTML = `
          <div style="color:#111;">
            <h2 style="margin:0;color:#007AFF;">Customer Summary — ${c.customer_id}</h2>
            <div style="color:#666;margin-bottom:20px;">Generated: ${formatDateISOToLocalShort(nowISO())}</div>
            
            <div style="background:#f8f9fa;padding:15px;border-radius:8px;margin-bottom:20px;">
              <h4 style="margin:0 0 10px 0;color:#333;">Basic Information</h4>
              <div><strong>Name:</strong> ${c.first_name} ${c.last_name}</div>
              <div><strong>Phone / Email:</strong> ${c.phone || '-'} / ${c.email || '-'}</div>
              <div><strong>Branch / Zone / RH:</strong> ${c.branch || '-'} / ${c.zone || '-'} / ${c.rh || '-'}</div>
              <div><strong>Occupation / Income:</strong> ${c.occupation || '-'} / ${c.monthly_income || 0}</div>
            </div>
            
            <div style="background:#f8f9fa;padding:15px;border-radius:8px;margin-bottom:20px;">
              <h4 style="margin:0 0 10px 0;color:#333;">Products</h4>
              <table style="width:100%; border-collapse:collapse;">
                <thead>
                  <tr style="background:#e9ecef;">
                    <th style="text-align:left;padding:8px;">Name</th>
                    <th style="text-align:right;padding:8px;">Sum</th>
                    <th style="text-align:right;padding:8px;">Premium</th>
                  </tr>
                </thead>
                <tbody>
                  ${(c.products || []).map(p => `
                    <tr>
                      <td style="padding:8px;border-bottom:1px solid #dee2e6;">${p.product_name}</td>
                      <td style="text-align:right;padding:8px;border-bottom:1px solid #dee2e6;">${p.sum_assured || 0}</td>
                      <td style="text-align:right;padding:8px;border-bottom:1px solid #dee2e6;">${p.premium || 0}</td>
                    </tr>
                  `).join('') || '<tr><td colspan="3" style="padding:8px;text-align:center;">-</td></tr>'}
                </tbody>
              </table>
            </div>
            
            <div style="background:#f8f9fa;padding:15px;border-radius:8px;margin-bottom:20px;">
              <h4 style="margin:0 0 10px 0;color:#333;">Opportunities</h4>
              ${(c.opportunities || []).map(o => `
                <div style="margin-bottom:10px;">
                  <strong>${o.type || '-'}</strong> | ${o.estimated_value || 0} THB | ${o.status || '-'}
                  <div style="color:#666;font-size:14px;">${o.comment || ''}</div>
                </div>
              `).join('')}
            </div>
            
            ${c.comments && c.comments.length > 0 ? `
            <div style="background:#f8f9fa;padding:15px;border-radius:8px;margin-bottom:20px;">
              <h4 style="margin:0 0 10px 0;color:#333;">Comments & Collaboration</h4>
              ${c.comments.map(comment => `
                <div style="margin-bottom:8px;padding:8px;background:white;border-radius:4px;">
                  <div style="font-size:12px;color:#666;">
                    <strong>${comment.user}</strong> - ${comment.timestamp}
                  </div>
                  <div>${comment.text}</div>
                </div>
              `).join('')}
            </div>
            ` : ''}
            
            <div style="font-size:11px;color:#999;text-align:center;margin-top:30px;">
              Confidential — For internal use only. Exported by enhanced account planning system.
            </div>
          </div>
        `;
        
        document.body.appendChild(wrapper);
        
        try {
          const canvas = await html2canvas(wrapper, { 
            scale: 2, 
            useCORS: true, 
            backgroundColor: '#ffffff',
            logging: false
          });
          
          const imgData = canvas.toDataURL('image/png');
          const imgProps = doc.getImageProperties(imgData);
          const pdfWidth = doc.internal.pageSize.getWidth();
          const pdfHeight = (imgProps.height * pdfWidth) / imgProps.width;
          
          doc.addImage(imgData, 'PNG', 0, 0, pdfWidth, pdfHeight);
          if (i < items.length - 1) doc.addPage();
        } catch (error) {
          console.error('Error generating PDF:', error);
          showNotification('เกิดข้อผิดพลาดในการสร้าง PDF', 'error');
        } finally {
          document.body.removeChild(wrapper);
        }
      }
      
      doc.save(`APS_Export_${new Date().toISOString().slice(0,19).replace(/[:T]/g,'_')}.pdf`);
    }

    // ---------- Report and Dashboard Functions ----------
    let reportUnlocked = false;

    function unlockReports() {
      const v = $('reportPass').value.trim();
      if (v === REPORT_PASSCODE) {
        reportUnlocked = true;
        $('reportLocked').style.display = 'none';
        $('reportPanel').style.display = 'block';
        appendAudit('report_unlock', 'report_panel', 'local-user', null);
        renderReport();
        showNotification('เข้าสู่ระบบรายงานเรียบร้อยแล้ว', 'success');
      } else {
        showNotification('Passcode ไม่ถูกต้อง', 'error');
      }
    }

    function isMTD(isoDate) {
      if (!isoDate) return false;
      const d = new Date(isoDate);
      const now = new Date();
      return d.getFullYear() === now.getFullYear() && 
             d.getMonth() === now.getMonth() && 
             d.getDate() <= now.getDate();
    }

    function renderReport() {
      if (!reportUnlocked) return;
      
      const region = $('filter_report_region').value;
      const startDate = $('filter_start_date').value;
      const endDate = $('filter_end_date').value;
      const position = $('filter_report_position').value;
      
      let all = loadData();
      
      // Apply filters
      if (region && region !== 'all') {
        all = all.filter(c => c.rh === region);
      }
      
      if (startDate && endDate) {
        all = all.filter(c => {
          const custDate = new Date(c.created_at);
          return custDate >= new Date(startDate) && custDate <= new Date(endDate);
        });
      }
      
      // Filter MTD for KPI
      const listMTD = all.filter(c => isMTD(c.created_at));
      
      // Update KPIs
      $('kpi_total').textContent = listMTD.length;
      
      const opps = listMTD.flatMap(c => 
        (c.opportunities || []).map(o => ({...o, customer_id: c.customer_id}))
      );
      
      $('kpi_opp_count').textContent = opps.length;
      
      const totalOppVal = opps.reduce((s, o) => s + (Number(o.estimated_value) || 0), 0);
      $('kpi_opp_value').textContent = totalOppVal.toLocaleString();
      
      // Top branch
      const branchCounts = {};
      listMTD.forEach(c => { 
        branchCounts[c.branch] = (branchCounts[c.branch] || 0) + 1; 
      });
      
      const topBranch = Object.entries(branchCounts).sort((a, b) => b[1] - a[1])[0];
      $('kpi_top_branch').textContent = topBranch ? `${topBranch[0]} (${topBranch[1]})` : '-';
      
      // Render Charts
      renderCharts(all, listMTD);
      
      // Render Team Overview
      renderTeamOverview(region);
    }

    function renderCharts(all, listMTD) {
      // RH Distribution Chart
      const rhLabels = ['RH1', 'RH2', 'RH3', 'RH4', 'RH5'];
      const rhData = rhLabels.map(r => listMTD.filter(c => c.rh === r).length);
      
      const ctxRh = $('chartRh').getContext('2d');
      if (window._chartRh) window._chartRh.destroy();
      
      window._chartRh = new Chart(ctxRh, {
        type: 'bar',
        data: {
          labels: rhLabels,
          datasets: [{
            label: 'Cases MTD',
            data: rhData,
            backgroundColor: [
              '#007AFF', '#34C759', '#FF9500', '#FF3B30', '#5856D6'
            ],
            borderColor: [
              '#0056CC', '#2CA24F', '#E08500', '#D32F2F', '#4847C4'
            ],
            borderWidth: 1
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          plugins: {
            legend: {
              display: false
            },
            title: {
              display: true,
              text: 'Cases by RH'
            }
          }
        }
      });
      
      // Branch Distribution Chart
      const branchCounts = {};
      all.forEach(c => { 
        branchCounts[c.branch] = (branchCounts[c.branch] || 0) + 1; 
      });
      
      const branchEntries = Object.entries(branchCounts)
        .sort((a, b) => b[1] - a[1])
        .slice(0, 8);
      
      const branchLabels = branchEntries.map(e => e[0] || '-');
      const branchVals = branchEntries.map(e => e[1]);
      
      const ctxBranch = $('chartBranch').getContext('2d');
      if (window._chartBranch) window._chartBranch.destroy();
      
      window._chartBranch = new Chart(ctxBranch, {
        type: 'bar',
        data: {
          labels: branchLabels,
          datasets: [{
            label: 'Total Cases',
            data: branchVals,
            backgroundColor: '#007AFF',
            borderColor: '#0056CC',
            borderWidth: 1
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          plugins: {
            legend: {
              display: false
            },
            title: {
              display: true,
              text: 'Top Branches'
            }
          }
        }
      });
    }

    function renderTeamOverview(region = 'all') {
      const teamScroll = $('teamScroll');
      const trainers = [
        { id: '1', name: 'Trainer RH1', region: 'RH1', avatar: '👨‍💼', totalMTD: 45, newCases: 3 },
        { id: '2', name: 'Trainer RH2', region: 'RH2', avatar: '👩‍💼', totalMTD: 38, newCases: 5 },
        { id: '3', name: 'Trainer RH3', region: 'RH3', avatar: '👨‍💼', totalMTD: 52, newCases: 2 },
        { id: '4', name: 'Trainer RH4', region: 'RH4', avatar: '👩‍💼', totalMTD: 29, newCases: 4 },
        { id: '5', name: 'Trainer RH5', region: 'RH5', avatar: '👨‍💼', totalMTD: 41, newCases: 1 },
      ];
      
      const filteredTrainers = region === 'all' 
        ? trainers 
        : trainers.filter(t => t.region === region);
      
      teamScroll.innerHTML = filteredTrainers.map(trainer => `
        <div class="trainer-card" onclick="viewTrainerDetail('${trainer.id}')">
          <div class="trainer-avatar">${trainer.avatar}</div>
          <div style="font-weight:600;font-size:0.875rem;">${trainer.region}</div>
          <div class="trainer-stats">
            <span class="stat-badge">${trainer.totalMTD}</span>
            <span class="stat-badge" style="background:#FF9500;">${trainer.newCases}</span>
          </div>
        </div>
      `).join('');
    }

    // ---------- Collaboration Features ----------
    function addComment(customerId) {
      const all = loadData();
      const customer = all.find(c => c.customer_id === customerId);
      
      if (!customer) {
        showNotification('ไม่พบข้อมูลลูกค้า', 'error');
        return;
      }
      
      const commentText = prompt('กรอกความคิดเห็นของคุณ:');
      if (!commentText || commentText.trim() === '') return;
      
      // Get current user (in real app, this would be from auth system)
      const currentUser = prompt('กรอกชื่อผู้แสดงความคิดเห็น:') || 'Anonymous';
      
      if (!customer.comments) {
        customer.comments = [];
      }
      
      customer.comments.push({
        id: Date.now().toString(),
        text: commentText.trim(),
        user: currentUser,
        timestamp: formatDateISOToLocalShort(new Date())
      });
      
      customer.updated_at = nowISO();
      saveData(all);
      
      appendAudit('add_comment', customerId, currentUser, {
        comment_preview: commentText.trim().substring(0, 50) + '...'
      });
      
      refreshList();
      showNotification('เพิ่มความคิดเห็นเรียบร้อยแล้ว', 'success');
    }

    function viewDetail(customerId) {
      const all = loadData();
      const c = all.find(x => x.customer_id === customerId);
      if (!c) {
        showNotification('ไม่พบข้อมูลลูกค้า', 'error');
        return;
      }
      
      const commentsHTML = c.comments && c.comments.length > 0 
        ? c.comments.map(comment => `
            <div class="comment">
              <div class="comment-header">
                <span>${comment.user}</span>
                <span>${comment.timestamp}</span>
              </div>
              <div>${comment.text}</div>
            </div>
          `).join('')
        : '<div class="text-muted">ยังไม่มีความคิดเห็น</div>';
      
      const html = `
        <div class="container-fluid py-4">
          <div class="d-flex justify-content-between align-items-center mb-4">
            <h3>${c.first_name} ${c.last_name} (${c.customer_id})</h3>
            <button class="btn btn-sm btn-outline-primary" onclick="window.print()">
              <i class="fas fa-print"></i> Print
            </button>
          </div>
          
          <div class="row">
            <div class="col-md-6">
              <div class="card mb-4">
                <div class="card-header bg-primary text-white">
                  <i class="fas fa-info-circle"></i> ข้อมูลพื้นฐาน
                </div>
                <div class="card-body">
                  <p><strong>ชื่อ-นามสกุล:</strong> ${c.first_name} ${c.last_name}</p>
                  <p><strong>เบอร์โทร:</strong> ${c.phone || '-'}</p>
                  <p><strong>อีเมล:</strong> ${c.email || '-'}</p>
                  <p><strong>ที่อยู่:</strong> ${c.address || '-'}</p>
                  <p><strong>อาชีพ:</strong> ${c.occupation || '-'}</p>
                  <p><strong>รายได้/เดือน:</strong> ${c.monthly_income ? c.monthly_income.toLocaleString() : '-'} บาท</p>
                </div>
              </div>
              
              <div class="card mb-4">
                <div class="card-header bg-success text-white">
                  <i class="fas fa-boxes"></i> ผลิตภัณฑ์ที่มีอยู่
                </div>
                <div class="card-body">
                  ${(c.products || []).length > 0 
                    ? c.products.map(p => `
                        <div class="border-bottom pb-2 mb-2">
                          <strong>${p.product_name}</strong><br>
                          <small class="text-muted">Sum: ${p.sum_assured || 0} | Premium: ${p.premium || 0}</small>
                        </div>
                      `).join('')
                    : '<p class="text-muted">ไม่มีข้อมูลผลิตภัณฑ์</p>'
                  }
                </div>
              </div>
            </div>
            
            <div class="col-md-6">
              <div class="card mb-4">
                <div class="card-header bg-info text-white">
                  <i class="fas fa-bullseye"></i> โอกาสทางธุรกิจ
                </div>
                <div class="card-body">
                  ${(c.opportunities || []).map(o => `
                    <div class="border-bottom pb-2 mb-2">
                      <strong>${o.type || '-'}</strong><br>
                      <small>มูลค่า: ${o.estimated_value ? o.estimated_value.toLocaleString() : 0} THB | สถานะ: ${o.status || '-'}</small>
                      <p class="mb-0 mt-1">${o.comment || ''}</p>
                    </div>
                  `).join('') || '<p class="text-muted">ไม่มีข้อมูลโอกาสทางธุรกิจ</p>'}
                </div>
              </div>
              
              <div class="card">
                <div class="card-header bg-warning text-dark">
                  <i class="fas fa-comments"></i> ความคิดเห็นและการร่วมวิเคราะห์
                </div>
                <div class="card-body">
                  ${commentsHTML}
                  <div class="mt-3">
                    <button class="btn btn-sm btn-primary" onclick="addComment('${c.customer_id}')">
                      <i class="fas fa-plus"></i> เพิ่มความคิดเห็น
                    </button>
                  </div>
                </div>
              </div>
            </div>
          </div>
          
          <div class="mt-4 p-3 bg-light rounded">
            <small class="text-muted">
              สร้างโดย: ${c.created_by_name || c.created_by} | 
              วันที่สร้าง: ${formatDateISOToLocalShort(c.created_at)} | 
              อัปเดตล่าสุด: ${formatDateISOToLocalShort(c.updated_at)}
            </small>
          </div>
        </div>
      `;
      
      const w = window.open('', '_blank', 'width=1200,height=800');
      w.document.write(`
        <!DOCTYPE html>
        <html>
        <head>
          <title>Customer Detail - ${c.customer_id}</title>
          <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
          <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
        </head>
        <body>
          ${html}
        </body>
        </html>
      `);
      w.document.close();
    }

    // ---------- Admin and Audit Functions ----------
    function renderAuditList() {
      const a = loadAudit();
      const container = $('auditList');
      
      container.innerHTML = a.map(x => `
        <div class="border-bottom pb-2 mb-2">
          <div class="d-flex justify-content-between">
            <strong>${x.action}</strong>
            <small class="text-muted">${formatDateISOToLocalShort(x.time)}</small>
          </div>
          <div>Entity: ${x.entity} | โดย: ${x.performed_by}</div>
          ${x.data ? `<small class="text-muted">ข้อมูล: ${JSON.stringify(x.data)}</small>` : ''}
        </div>
      `).join('') || '<div class="text-muted text-center py-3">ยังไม่มีบันทึกการใช้งาน</div>';
    }

    function resetAllData() {
      if (!confirm('คุณแน่ใจหรือไม่ที่จะลบข้อมูลทั้งหมด? การกระทำนี้ไม่สามารถย้อนกลับได้!')) {
        return;
      }
      
      localStorage.removeItem(STORAGE_KEY);
      localStorage.removeItem(AUDIT_KEY);
      localStorage.removeItem(COUNTER_KEY);
      
      refreshList();
      renderAuditList();
      if (reportUnlocked) renderReport();
      
      showNotification('ลบข้อมูลทั้งหมดเรียบร้อยแล้ว', 'success');
    }

    // ---------- Navigation and UI Management ----------
    function showPanel(name) {
      // Hide all panels
      document.querySelectorAll('[id^="panel-"]').forEach(panel => {
        panel.style.display = 'none';
      });
      
      // Remove active class from all menu items
      document.querySelectorAll('.menu-card').forEach(item => {
        item.classList.remove('active');
      });
      
      // Show selected panel and activate menu
      $(`panel-${name}`).style.display = 'block';
      $(`tab-${name}`).classList.add('active');
      
      // Special handling for reports panel
      if (name === 'report' && !reportUnlocked) {
        $('reportLocked').style.display = 'block';
        $('reportPanel').style.display = 'none';
      }
    }

    // ---------- Event Listeners and Initialization ----------
    document.addEventListener('DOMContentLoaded', function() {
      // Initialize demo data if empty
      function initDemoData() {
        if (loadData().length === 0) {
          const demo = [
            { 
              customer_id: genCustomerCode(), 
              first_name: 'สมชาย', 
              last_name: 'ใจดี', 
              phone: '0811111111', 
              email: 's@example.com', 
              branch: 'Bangkok Central', 
              zone: 'Zone A', 
              rh: 'RH1', 
              products: [
                { product_name: 'ABC Life 20Y', sum_assured: 1000000, premium: 50000 }
              ], 
              opportunities: [
                {
                  type: 'Protection', 
                  estimated_value: 50000, 
                  status: 'Open', 
                  comment: 'Need health cover', 
                  created_at: nowISO(), 
                  created_by: 'BR1001'
                }
              ], 
              created_by: 'BR1001', 
              created_by_name: 'Somchai', 
              created_at: nowISO(), 
              updated_at: nowISO(), 
              attachments: [], 
              occupation: 'พนักงานบริษัท', 
              monthly_income: 40000, 
              consent: true,
              comments: [
                {
                  id: '1',
                  text: 'แนะนำผลิตภัณฑ์สุขภาพเพิ่มเติม',
                  user: 'Trainer RH1',
                  timestamp: formatDateISOToLocalShort(new Date())
                }
              ]
            },
            { 
              customer_id: genCustomerCode(), 
              first_name: 'มาลี', 
              last_name: 'สมหวัง', 
              phone: '0822222222', 
              email: 'm@example.com', 
              branch: 'North Branch', 
              zone: 'Zone B', 
              rh: 'RH3', 
              products: [], 
              opportunities: [
                {
                  type: 'Wealth', 
                  estimated_value: 200000, 
                  status: 'Open', 
                  comment: 'Has savings to invest', 
                  created_at: nowISO(), 
                  created_by: 'BR2002'
                }
              ], 
              created_by: 'BR2002', 
              created_by_name: 'Malee', 
              created_at: nowISO(), 
              updated_at: nowISO(), 
              attachments: [], 
              occupation: 'เจ้าของกิจการ', 
              monthly_income: 90000, 
              consent: true,
              comments: []
            }
          ];
          saveData(demo);
        }
      }

      // Navigation event listeners
      $('tab-form').addEventListener('click', () => showPanel('form'));
      $('tab-list').addEventListener('click', () => showPanel('list'));
      $('tab-report').addEventListener('click', () => showPanel('report'));
      $('tab-admin').addEventListener('click', () => showPanel('admin'));
      
      // Form event listeners
      $('btnAddProd').addEventListener('click', () => {
        const name = $('prod_name').value.trim();
        const sum = Number($('prod_sum').value || 0);
        const prem = Number($('prod_premium').value || 0);
        
        if (!name) {
          showNotification('กรุณาใส่ชื่อผลิตภัณฑ์', 'error');
          return;
        }
        
        tmpProducts.push({ product_name: name, sum_assured: sum, premium: prem });
        $('prod_name').value = '';
        $('prod_sum').value = '';
        $('prod_premium').value = '';
        renderProdList();
      });
      
      $('file_attach').addEventListener('change', async (ev) => {
        const f = ev.target.files[0];
        if (!f) return;
        
        // Limit file size to 2MB for demo
        if (f.size > 2 * 1024 * 1024) {
          showNotification('ไฟล์ใหญ่เกิน 2MB (demo limit)', 'error');
          return;
        }
        
        const reader = new FileReader();
        reader.onload = () => {
          tmpAttachments.push({ 
            name: f.name, 
            type: f.type, 
            dataUrl: reader.result 
          });
          renderAttachList();
        };
        reader.readAsDataURL(f);
        ev.target.value = '';
      });
      
      $('btnClear').addEventListener('click', clearForm);
      $('btnSave').addEventListener('click', saveCustomer);
      
      // List and search event listeners
      $('btnSearch').addEventListener('click', searchCustomers);
      $('btnRefresh').addEventListener('click', refreshList);
      $('btnBulkExport').addEventListener('click', async () => {
        const checks = Array.from(document.querySelectorAll('.rowSelect:checked'));
        if (!checks.length) {
          showNotification('เลือกอย่างน้อย 1 รายการเพื่อ export', 'warning');
          return;
        }
        
        const ids = checks.map(ch => ch.dataset.id);
        const all = loadData();
        const items = all.filter(c => ids.includes(c.customer_id));
        
        await exportMultiplePDF(items);
        appendAudit('export_bulk_pdf', `bulk:${ids.join(',')}`, 'local-user', { 
          count: items.length 
        });
        
        showNotification(`Export PDF จำนวน ${items.length} รายการเรียบร้อยแล้ว`, 'success');
      });
      
      $('selectAll').addEventListener('change', (e) => {
        document.querySelectorAll('.rowSelect').forEach(cb => {
          cb.checked = e.target.checked;
        });
      });
      
      // Report event listeners
      $('btnUnlock').addEventListener('click', unlockReports);
      $('btnExportAll').addEventListener('click', async () => {
        const all = loadData();
        if (!all.length) {
          showNotification('ไม่มีข้อมูลสำหรับ export', 'warning');
          return;
        }
        
        await exportMultiplePDF(all);
        appendAudit('export_all_pdf', 'all', 'local-user', { 
          count: all.length 
        });
        
        showNotification(`Export PDF ทั้งหมด ${all.length} รายการเรียบร้อยแล้ว`, 'success');
      });
      
      $('btnExportCSV').addEventListener('click', () => {
        const all = loadData();
        const rows = all.map(c => ({
          customer_id: c.customer_id,
          name: `${c.first_name} ${c.last_name}`,
          branch: c.branch,
          rh: c.rh,
          created_by: c.created_by,
          created_at: c.created_at
        }));
        
        const csv = [Object.keys(rows[0] || {}).join(',')]
          .concat(rows.map(r => 
            Object.values(r).map(v => 
              `"${String(v || '').replace(/"/g, '""')}"`
            ).join(','))
          ).join('\n');
        
        const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = `aps_export_${new Date().toISOString().slice(0,10)}.csv`;
        a.click();
        URL.revokeObjectURL(url);
        
        appendAudit('export_csv', 'all', 'local-user', { 
          count: rows.length 
        });
        
        showNotification('Export CSV เรียบร้อยแล้ว', 'success');
      });
      
      $('btnApplyFilters').addEventListener('click', renderReport);
      $('btnRefreshTeam').addEventListener('click', () => {
        const region = $('filter_report_region').value;
        renderTeamOverview(region);
      });
      
      // Admin event listeners
      $('btnRefreshAudit').addEventListener('click', renderAuditList);
      $('btnExportAudit').addEventListener('click', () => {
        const audit = loadAudit();
        const csv = [['Action', 'Entity', 'Performed By', 'Time', 'Data'].join(',')]
          .concat(audit.map(a => 
            [a.action, a.entity, a.performed_by, a.time, JSON.stringify(a.data || '')]
              .map(v => `"${String(v || '').replace(/"/g, '""')}"`)
              .join(',')
          )).join('\n');
        
        const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = `audit_log_${new Date().toISOString().slice(0,10)}.csv`;
        a.click();
        URL.revokeObjectURL(url);
        
        showNotification('Export Audit Log เรียบร้อยแล้ว', 'success');
      });
      
      $('btnResetAll').addEventListener('click', resetAllData);
      
      // Team view and logout
      $('btn-team-view').addEventListener('click', () => {
        showPanel('report');
        if (!reportUnlocked) {
          $('reportPass').focus();
        }
      });
      
      $('btn-logout').addEventListener('click', () => {
        if (confirm('คุณต้องการออกจากระบบหรือไม่?')) {
          reportUnlocked = false;
          showPanel('form');
          showNotification('ออกจากระบบเรียบร้อยแล้ว', 'info');
        }
      });
      
      // Initialize the application
      initDemoData();
      refreshList();
      renderAuditList();
      renderTeamOverview();
      showPanel('form');
      
      // Initial render of product and attachment lists
      renderProdList();
      renderAttachList();
      
      // Check for select all functionality
      document.addEventListener('click', (e) => {
        if (e.target && e.target.matches('.rowSelect')) {
          const all = document.querySelectorAll('.rowSelect');
          const checked = Array.from(all).filter(cb => cb.checked).length;
          $('selectAll').checked = checked === all.length;
        }
      });
      
      // Add keyboard shortcut for saving (Ctrl+S)
      document.addEventListener('keydown', (e) => {
        if ((e.ctrlKey || e.metaKey) && e.key === 's') {
          e.preventDefault();
          saveCustomer();
        }
      });
    });

    // ---------- Global Functions for HTML onclick ----------
    window.removeProd = function(i) { 
      tmpProducts.splice(i, 1); 
      renderProdList(); 
    };
    
    window.removeAttach = function(i) { 
      tmpAttachments.splice(i, 1); 
      renderAttachList(); 
    };
    
    window.viewDetail = viewDetail;
    window.exportSinglePDF = exportSinglePDF;
    window.addComment = addComment;
    
    window.deleteRecord = function(customerId) {
      if (!confirm('ลบรายการนี้จริงหรือไม่?')) return;
      
      let all = loadData();
      const customer = all.find(c => c.customer_id === customerId);
      all = all.filter(x => x.customer_id !== customerId);
      saveData(all);
      
      appendAudit('delete', customerId, 'local-user', {
        customer_name: customer ? `${customer.first_name} ${customer.last_name}` : 'Unknown'
      });
      
      refreshList();
      if (reportUnlocked) renderReport();
      
      showNotification('ลบข้อมูลลูกค้าเรียบร้อยแล้ว', 'success');
    };
    
    window.viewTrainerDetail = function(trainerId) {
      alert(`ดูข้อมูล Trainer ${trainerId} (ฟีเจอร์นี้อยู่ในระหว่างการพัฒนา)`);
    };
  </script>
</body>
</html>
